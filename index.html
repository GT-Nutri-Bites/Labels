<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>GT Nutri Bites â€” Label Studio Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Nunito:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
/* â”€â”€ CSS VARIABLES â”€â”€ */
:root {
  --forest:#1e4d2b;--forest-d:#163820;--forest-l:#2d6b3c;
  --sage:#5a8a4a;--leaf:#88b878;--leaf-l:#b4d4a0;
  --honey:#c8961e;--honey-l:#f0c84a;--honey-d:#a07810;
  --cream:#faf8f2;--cream-d:#f0ece0;--parchment:#e8e2d0;
  --bark:#3d2b1a;--ink:#1a1a0e;--mist:#6b7a5e;
  --white:#ffffff;--red:#b91c1c;
  --sidebar:330px;--header:56px;
  --radius:10px;
  --shadow-sm:0 1px 3px rgba(0,0,0,.08);
  --shadow:0 4px 16px rgba(30,50,20,.12);
  --shadow-lg:0 12px 40px rgba(30,50,20,.18);
  --transition:.18s cubic-bezier(.4,0,.2,1);
}
.dark-mode {
  --forest:#3d9e5a;--forest-d:#2d6b3c;--forest-l:#50b870;
  --honey:#f0c84a;--honey-d:#c8961e;
  --cream:#161c14;--cream-d:#1e271b;--parchment:#2a3628;
  --bark:#c8b898;--ink:#f0ece0;--mist:#8aaa78;
  --white:#1a2318;--red:#f87171;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth;height:100%}
body{font-family:'Nunito',sans-serif;background:var(--cream);color:var(--ink);min-height:100vh;font-size:14px;transition:background var(--transition),color var(--transition)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--parchment);border-radius:3px}
::-webkit-scrollbar-track{background:transparent}

/* â”€â”€ LAYOUT â”€â”€ */
#sidebar{position:fixed;left:0;top:0;bottom:0;width:var(--sidebar);background:var(--white);border-right:1.5px solid var(--cream-d);display:flex;flex-direction:column;z-index:50;overflow-y:auto;transition:transform .3s cubic-bezier(.4,0,.2,1),background var(--transition)}
#header{position:fixed;top:0;left:var(--sidebar);right:0;height:var(--header);background:var(--forest);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:40;box-shadow:0 2px 12px rgba(0,0,0,.2)}
#main{margin-left:var(--sidebar);padding-top:var(--header);min-height:100vh;display:flex;flex-direction:column}
#sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:45;backdrop-filter:blur(3px)}

/* â”€â”€ SIDEBAR BRAND â”€â”€ */
.sb-brand{padding:14px 16px;background:linear-gradient(135deg,var(--forest-d),var(--forest));color:#fff;flex-shrink:0;border-bottom:1px solid rgba(255,255,255,.08)}
.sb-logo{width:44px;height:44px;border-radius:9px;object-fit:contain;background:rgba(255,255,255,.12);padding:4px;border:1px solid rgba(255,255,255,.15)}

/* â”€â”€ TABS â”€â”€ */
.tab-bar{display:flex;border-bottom:1.5px solid var(--cream-d);flex-shrink:0;background:var(--cream);overflow-x:auto}
.tab{flex:1;min-width:0;padding:10px 4px;font-size:10.5px;font-weight:800;letter-spacing:.04em;text-align:center;cursor:pointer;color:var(--mist);border-bottom:2.5px solid transparent;margin-bottom:-1.5px;transition:all .2s;user-select:none;white-space:nowrap}
.tab:hover{color:var(--forest);background:rgba(30,77,43,.04)}
.tab.active{color:var(--forest);border-bottom-color:var(--honey);background:var(--white)}
.tab-panel{display:none;flex:1;overflow-y:auto;padding-bottom:32px}
.tab-panel.active{display:block}

/* â”€â”€ SECTION HEADERS â”€â”€ */
.sec{font-size:10px;font-weight:800;letter-spacing:.1em;text-transform:uppercase;color:var(--honey);padding:12px 16px 5px;border-top:1px solid var(--cream-d);margin-top:2px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;transition:background .15s}
.sec:first-child{border-top:none}
.sec:hover{background:var(--cream)}
.sec-body{overflow:hidden;max-height:0;transition:max-height .35s ease}
.sec-body.open{max-height:4000px}
.sec.open .chev{transform:rotate(180deg)}
.chev{font-size:9px;transition:transform .25s;opacity:.5;flex-shrink:0}
.field{padding:0 16px 10px}
.flabel{display:flex;align-items:center;gap:5px;font-size:10px;font-weight:800;letter-spacing:.06em;text-transform:uppercase;color:var(--mist);margin-bottom:4px}
.req{color:var(--honey)}
.finput{width:100%;border:1.5px solid var(--parchment);border-radius:8px;padding:7px 10px;font-family:'Nunito',sans-serif;font-size:13px;background:var(--cream);color:var(--ink);outline:none;transition:border-color .2s,box-shadow .2s,background .2s}
.finput:focus{border-color:var(--forest);background:var(--white);box-shadow:0 0 0 3px rgba(30,77,43,.12)}
.finput::placeholder{color:#b0a898;font-size:12px}
textarea.finput{resize:vertical;min-height:52px;line-height:1.5}
select.finput{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='%236b7a5e' d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 10px center;background-size:12px;padding-right:28px}

/* â”€â”€ LABEL TYPE GRID â”€â”€ */
.ltype-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;padding:0 16px 10px}
.ltype-card{border:1.5px solid var(--parchment);border-radius:9px;padding:9px 4px;cursor:pointer;text-align:center;font-size:10px;font-weight:700;line-height:1.3;transition:all .2s;background:var(--cream);color:var(--mist)}
.ltype-card:hover{border-color:var(--honey);color:var(--forest);background:var(--cream-d);transform:translateY(-1px);box-shadow:var(--shadow-sm)}
.ltype-card.active{border-color:var(--forest);background:var(--forest);color:#fff;box-shadow:0 3px 12px rgba(30,77,43,.25)}
.ltype-card .ico{font-size:18px;display:block;margin-bottom:3px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 14px;border-radius:8px;font-size:12.5px;font-weight:700;cursor:pointer;border:none;transition:all .18s;font-family:'Nunito',sans-serif;white-space:nowrap;letter-spacing:.02em;position:relative;overflow:hidden}
.btn:active{transform:translateY(1px)}
.btn::after{content:'';position:absolute;inset:0;background:rgba(255,255,255,.1);opacity:0;transition:opacity .15s}
.btn:hover::after{opacity:1}
.btn-forest{background:var(--forest);color:#fff;box-shadow:0 2px 8px rgba(30,77,43,.25)}
.btn-forest:hover{background:var(--forest-d)}
.btn-honey{background:var(--honey);color:#fff;box-shadow:0 2px 8px rgba(200,150,30,.3)}
.btn-honey:hover{background:var(--honey-d)}
.btn-outline{background:transparent;border:1.5px solid var(--parchment);color:var(--ink)}
.btn-outline:hover{background:var(--cream-d);border-color:#c0b8a8}
.btn-ghost{background:transparent;color:var(--mist)}
.btn-ghost:hover{background:var(--cream-d);color:var(--ink)}
.btn-danger{background:#fff1f2;color:var(--red);border:1px solid #fecdd3}
.btn-danger:hover{background:#fee2e2}
.btn-success{background:#d1fae5;color:var(--forest);border:1px solid #a7f3d0}
.btn-success:hover{background:#a7f3d0}
.btn-sheet{background:linear-gradient(135deg,var(--forest),var(--forest-l));color:#fff;box-shadow:0 3px 14px rgba(30,77,43,.3)}
.btn-sheet:hover{background:linear-gradient(135deg,var(--forest-d),var(--forest))}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-xs{padding:4px 9px;font-size:11px}
.btn-full{width:100%}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none}

/* â”€â”€ TOGGLE â”€â”€ */
.tog-row{display:flex;align-items:center;justify-content:space-between;padding:4px 0}
.tog-label{font-size:12.5px;color:var(--ink)}
.tog{position:relative;width:34px;height:18px;display:inline-block;flex-shrink:0}
.tog input{opacity:0;width:0;height:0}
.tog-track{position:absolute;inset:0;border-radius:9px;background:var(--parchment);transition:all .2s;cursor:pointer}
.tog-track::before{content:'';position:absolute;width:12px;height:12px;left:3px;bottom:3px;border-radius:50%;background:#fff;transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.tog input:checked+.tog-track{background:var(--forest)}
.tog input:checked+.tog-track::before{transform:translateX(16px)}

/* â”€â”€ RANGE â”€â”€ */
input[type="range"]{-webkit-appearance:none;width:100%;height:3px;border-radius:2px;background:var(--parchment);outline:none;cursor:pointer}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:15px;height:15px;border-radius:50%;background:var(--forest);box-shadow:0 1px 4px rgba(0,0,0,.2);cursor:pointer;transition:transform .15s}
input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.2)}
.rval{font-size:11px;font-weight:800;color:var(--forest);min-width:34px;text-align:right;font-family:'DM Mono',monospace}

/* â”€â”€ COLOR PICKER â”€â”€ */
.cpick-row{display:flex;gap:8px;align-items:center}
.cswatch-wrap{width:36px;height:36px;border-radius:8px;border:1.5px solid var(--parchment);overflow:hidden;flex-shrink:0;position:relative;cursor:pointer;box-shadow:var(--shadow-sm)}
.cswatch-wrap input[type="color"]{position:absolute;inset:-4px;width:calc(100%+8px);height:calc(100%+8px);cursor:pointer;border:none;padding:0}
.quick-swatches{display:flex;gap:5px;flex-wrap:wrap;margin-top:6px}
.qswatch{width:19px;height:19px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:transform .15s,box-shadow .15s;flex-shrink:0}
.qswatch:hover{transform:scale(1.3);box-shadow:0 2px 6px rgba(0,0,0,.2)}
.qswatch.sel{box-shadow:0 0 0 2px var(--honey),0 0 0 4px rgba(200,150,30,.3)}

/* â”€â”€ ZOOM BAR â”€â”€ */
.zoom-bar{position:absolute;bottom:-44px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:4px;background:var(--white);border:1px solid var(--cream-d);border-radius:20px;padding:4px 8px;box-shadow:var(--shadow);white-space:nowrap}
.zbtn{background:none;border:none;cursor:pointer;font-size:14px;padding:3px 7px;border-radius:10px;transition:background .15s;color:var(--ink);font-weight:700;font-family:'Nunito',sans-serif}
.zbtn:hover{background:var(--cream-d)}
.zlbl{font-size:11px;font-weight:800;color:var(--mist);min-width:40px;text-align:center;font-family:'DM Mono',monospace}

/* â”€â”€ SIZE PILLS â”€â”€ */
.spill{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;border:1.5px solid var(--parchment);background:var(--cream);transition:all .15s;color:var(--mist);font-family:'DM Mono',monospace}
.spill:hover{border-color:var(--forest);color:var(--forest);background:rgba(30,77,43,.06)}
.spill.active{border-color:var(--forest);background:var(--forest);color:#fff}

/* â”€â”€ LOGO POS GRID â”€â”€ */
.lpg{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;border:1.5px solid var(--parchment);border-radius:9px;padding:5px;background:var(--cream)}
.lpc{aspect-ratio:1;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;background:transparent}
.lpc:hover{background:rgba(200,150,30,.15)}
.lpc.a{background:var(--forest)}
.lpc .dot{width:6px;height:6px;border-radius:50%;background:var(--parchment);transition:.15s}
.lpc.a .dot{background:#fff}

/* â”€â”€ MODAL â”€â”€ */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:8000;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(5px)}
.modal-bg.on{display:flex;animation:mBg .2s ease}
@keyframes mBg{from{opacity:0}to{opacity:1}}
.modal-box{background:var(--white);border-radius:16px;max-width:780px;width:100%;max-height:88vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:var(--shadow-lg);animation:mIn .25s cubic-bezier(.4,0,.2,1)}
@keyframes mIn{from{transform:scale(.95) translateY(8px);opacity:0}to{transform:none;opacity:1}}
.modal-head{padding:18px 22px 14px;border-bottom:1px solid var(--cream-d);display:flex;align-items:center;justify-content:space-between;background:var(--white)}
.modal-body{padding:18px 22px;overflow-y:auto;flex:1;background:var(--white)}
.modal-foot{padding:12px 22px;border-top:1px solid var(--cream-d);display:flex;gap:8px;justify-content:flex-end;background:var(--cream)}

/* â”€â”€ TOAST â”€â”€ */
#toast-area{position:fixed;top:14px;right:14px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;font-size:12.5px;font-weight:700;box-shadow:var(--shadow-lg);animation:tIn .25s ease;pointer-events:auto;max-width:300px}
.toast.out{animation:tOut .25s ease forwards}
.t-success{background:var(--forest);color:#d1fae5}
.t-error{background:#7f1d1d;color:#fee2e2}
.t-warn{background:var(--bark);color:#fde68a}
.t-info{background:#1e3a5f;color:#bfdbfe}
@keyframes tIn{from{transform:translateX(20px);opacity:0}to{transform:none;opacity:1}}
@keyframes tOut{to{transform:translateX(20px);opacity:0}}

/* â”€â”€ LOADING â”€â”€ */
#loading{display:none;position:fixed;inset:0;background:rgba(250,248,242,.9);z-index:9000;flex-direction:column;align-items:center;justify-content:center;gap:14px;backdrop-filter:blur(6px)}
#loading.on{display:flex}
.spin{width:42px;height:42px;border:3px solid var(--parchment);border-top-color:var(--forest);border-radius:50%;animation:spin .65s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.load-prog{width:220px;height:4px;background:var(--parchment);border-radius:2px;overflow:hidden}
.load-bar{height:100%;width:0;background:linear-gradient(90deg,var(--forest),var(--honey));transition:width .3s;border-radius:2px}

/* â”€â”€ PREVIEW â”€â”€ */
#preview-area{flex:1;display:flex;align-items:center;justify-content:center;padding:48px 24px;min-height:420px;background:radial-gradient(circle at 20px 20px,rgba(30,77,43,.04) 2%,transparent 0%),radial-gradient(circle at 60px 60px,rgba(200,150,30,.03) 2%,transparent 0%);background-size:80px 80px}
#label-canvas{background:#fff;border:2px dashed #c0b8a0;position:relative;overflow:hidden;box-shadow:var(--shadow-lg),0 0 0 1px rgba(0,0,0,.04);transition:width .3s,height .3s}
#label-inner{width:100%;height:100%;position:relative;overflow:hidden}

/* â”€â”€ BATCH â”€â”€ */
.batch-dz{border:2px dashed var(--parchment);border-radius:12px;padding:24px 16px;text-align:center;cursor:pointer;transition:all .2s;background:var(--cream)}
.batch-dz:hover,.batch-dz.over{border-color:var(--forest);background:rgba(30,77,43,.05)}
.batch-row{background:var(--white);border:1px solid var(--cream-d);border-radius:9px;padding:9px 12px;margin-bottom:5px;display:flex;align-items:center;gap:10px;transition:border-color .15s}
.batch-row:hover{border-color:var(--leaf)}
.bnum{width:22px;height:22px;border-radius:50%;background:var(--forest);color:#fff;font-size:10px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-family:'DM Mono',monospace}
.bstat{font-size:10px;margin-left:auto;font-family:'DM Mono',monospace}
.bstat.done{color:var(--sage)}.bstat.err{color:var(--red)}.bstat.pend{color:#b0a898}
#batch-prog{height:4px;background:var(--parchment);border-radius:3px;overflow:hidden;margin:8px 0}
#batch-fill{height:100%;width:0;background:linear-gradient(90deg,var(--forest),var(--honey));transition:width .3s;border-radius:3px}

/* â”€â”€ TIP CARDS â”€â”€ */
.tip-card{background:var(--white);border:1px solid var(--cream-d);border-radius:12px;padding:14px;border-left:3px solid var(--leaf);transition:all .2s}
.tip-card:hover{border-left-color:var(--honey);transform:translateY(-2px);box-shadow:var(--shadow)}

/* â”€â”€ BADGE â”€â”€ */
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:20px;font-size:10.5px;font-weight:700}
.badge-forest{background:rgba(30,77,43,.1);color:var(--forest)}
.badge-honey{background:rgba(200,150,30,.15);color:#7a5a0a}
.badge-new{background:linear-gradient(135deg,#c8961e,#f0c84a);color:#fff;font-size:9px;padding:1px 6px}

/* â”€â”€ CSV PRE â”€â”€ */
.csv-pre{font-family:'DM Mono',monospace;font-size:10.5px;background:#f1f5f0;border-radius:8px;padding:12px;overflow-x:auto;white-space:pre;border:1px solid #d4e0cc;color:#2d4a1e;max-height:200px;overflow-y:auto;line-height:1.7}

/* â”€â”€ STEP INDICATOR â”€â”€ */
.step-badge{width:22px;height:22px;border-radius:50%;background:var(--forest);color:#fff;font-size:10px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-family:'DM Mono',monospace}
.step-box{background:var(--cream);border-radius:10px;padding:12px;margin-bottom:10px;border:1px solid var(--cream-d)}

/* â”€â”€ SHEET PREVIEW â”€â”€ */
.sheet-preview-area{background:#e0e0e0;border-radius:8px;padding:20px;display:flex;align-items:center;justify-content:center;min-height:300px;overflow:auto}
.sheet-page{background:#fff;box-shadow:0 4px 20px rgba(0,0,0,.25);position:relative;overflow:hidden}
.sheet-label-cell{position:absolute;overflow:hidden;box-sizing:border-box}
.cut-mark-h,.cut-mark-v{position:absolute;background:#ccc;pointer-events:none}
.cut-mark-h{height:1px;width:8px}
.cut-mark-v{width:1px;height:8px}

/* â”€â”€ COPY COUNT â”€â”€ */
.copy-input{width:60px;border:1.5px solid var(--parchment);border-radius:7px;padding:5px 8px;font-family:'DM Mono',monospace;font-size:13px;background:var(--cream);color:var(--ink);outline:none;text-align:center;transition:border-color .2s}
.copy-input:focus{border-color:var(--forest);background:var(--white)}

/* â”€â”€ DARK MODE ADJUSTMENTS â”€â”€ */
.dark-mode .csv-pre{background:#1e2a1e;border-color:#3a5a3a;color:#a0d090}
.dark-mode .sheet-preview-area{background:#1a1a1a}
.dark-mode .sheet-page{background:#2a2a2a;box-shadow:0 4px 20px rgba(0,0,0,.6)}

/* â”€â”€ HISTORY BUTTONS â”€â”€ */
.hist-btn{background:var(--cream);border:1.5px solid var(--parchment);border-radius:7px;padding:4px 9px;font-size:11px;font-weight:700;cursor:pointer;color:var(--mist);transition:all .15s;font-family:'Nunito',sans-serif}
.hist-btn:hover:not(:disabled){border-color:var(--forest);color:var(--forest);background:rgba(30,77,43,.06)}
.hist-btn:disabled{opacity:.35;cursor:not-allowed}

/* â”€â”€ SHORTCUTS TABLE â”€â”€ */
.kbt{display:inline-flex;align-items:center;justify-content:center;padding:2px 7px;border-radius:5px;font-family:'DM Mono',monospace;font-size:11px;background:var(--cream-d);border:1px solid var(--parchment);color:var(--ink);font-weight:500}

/* â”€â”€ STATUS BAR â”€â”€ */
#status-bar{background:rgba(0,0,0,.15);height:20px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;font-size:10px;color:rgba(255,255,255,.7);font-family:'DM Mono',monospace}

/* â”€â”€ MOBILE â”€â”€ */
.mob-only{display:none}
@media(max-width:900px){
  #sidebar{transform:translateX(-100%)}
  #sidebar.open{transform:translateX(0);box-shadow:0 0 40px rgba(0,0,0,.3)}
  #header{left:0}
  #main{margin-left:0}
  #sidebar-overlay.on{display:block}
  .mob-only{display:flex}
  #preview-area{padding:20px 12px}
  .ltype-grid{grid-template-columns:1fr 1fr}
  :root{--sidebar:300px}
}

/* â”€â”€ PRINT â”€â”€ */
@media print{
  *,*::before,*::after{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}
  body>*{display:none!important}
  #print-root{display:block!important}
  @page{margin:0;size:auto}
}
#print-root{display:none}

/* â”€â”€ LABEL INNER â”€â”€ */
.lbl-row{display:flex;align-items:flex-start;gap:6px;font-size:inherit;margin:2px 0}
.lbl-divider{border:none;border-top:1.5px solid currentColor;opacity:.2;margin:5px 0}

/* â”€â”€ ANIMATIONS â”€â”€ */
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.fade-in{animation:fadeIn .25s ease}

/* â”€â”€ SECTION step styling â”€â”€ */
.subsec-title{font-size:10px;font-weight:800;letter-spacing:.1em;text-transform:uppercase;color:var(--honey);margin-bottom:8px}
</style>
</head>
<body>

<!-- TOAST AREA -->
<div id="toast-area" aria-live="polite"></div>

<!-- LOADING -->
<div id="loading" role="progressbar" aria-label="Processing">
  <div class="spin"></div>
  <div style="font-family:'Nunito',sans-serif;font-weight:700;color:var(--forest);font-size:14px;" id="load-txt">Processingâ€¦</div>
  <div style="font-size:12px;color:var(--mist);margin-top:2px;" id="load-sub"></div>
  <div class="load-prog"><div class="load-bar" id="load-bar"></div></div>
</div>

<!-- â•â• MODAL: CSV â•â• -->
<div class="modal-bg" id="csv-modal" role="dialog" aria-modal="true" aria-labelledby="csv-modal-title">
  <div class="modal-box">
    <div class="modal-head">
      <div><h3 id="csv-modal-title" style="font-family:'Playfair Display',serif;font-size:19px;color:var(--forest);">CSV Template Generator</h3>
        <div style="font-size:12px;color:var(--mist);margin-top:2px;">Download, fill in your data, then upload for batch printing</div></div>
      <button class="btn btn-ghost btn-xs" onclick="closeModal('csv-modal')" style="font-size:16px;padding:4px 8px;" aria-label="Close">âœ•</button>
    </div>
    <div class="modal-body">
      <p style="font-size:12px;color:var(--mist);margin-bottom:12px;">Select a label type to preview its CSV template and column descriptions.</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:7px;margin-bottom:14px;" id="csv-type-grid"></div>
      <div id="csv-preview-wrap" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;">
          <div style="font-weight:700;font-size:13px;color:var(--forest);" id="csv-type-title"></div>
          <div class="badge badge-forest" id="csv-col-badge"></div>
        </div>
        <div class="csv-pre" id="csv-pre-content"></div>
        <div style="margin-top:10px;background:rgba(200,150,30,.1);border:1px solid rgba(200,150,30,.3);border-radius:8px;padding:10px;font-size:12px;color:var(--bark);line-height:1.6;">
          ğŸŒ¿ <strong>Instructions:</strong> Row 1 = headers (do not edit). Each row after = one label. Blank optional fields are fine. Save as UTF-8 CSV before uploading.
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline btn-sm" onclick="closeModal('csv-modal')">Cancel</button>
      <button class="btn btn-forest btn-sm" onclick="downloadCSV()" id="btn-dl-csv" disabled>â¬‡ Download Template</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL: BATCH PREVIEW â•â• -->
<div class="modal-bg" id="batch-modal" role="dialog" aria-modal="true" aria-labelledby="batch-modal-title">
  <div class="modal-box" style="max-width:980px;">
    <div class="modal-head">
      <div><h3 id="batch-modal-title" style="font-family:'Playfair Display',serif;font-size:19px;color:var(--forest);">Batch Preview</h3>
        <div style="font-size:12px;color:var(--mist);margin-top:2px;" id="batch-modal-count"></div></div>
      <button class="btn btn-ghost btn-xs" onclick="closeModal('batch-modal')" style="font-size:16px;" aria-label="Close">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="batch-prev-grid" style="display:flex;flex-wrap:wrap;gap:12px;justify-content:center;"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline btn-sm" onclick="closeModal('batch-modal')">Close</button>
      <button class="btn btn-honey btn-sm" onclick="closeModal('batch-modal');switchTab('sheet',document.querySelector('[data-tab=sheet]'))">ğŸ“„ Print Sheet</button>
      <button class="btn btn-honey btn-sm" onclick="batchPrint();closeModal('batch-modal')">ğŸ–¨ Print All</button>
      <button class="btn btn-forest btn-sm" onclick="batchPDF();closeModal('batch-modal')">â¬‡ Export PDF</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL: SHEET PREVIEW â•â• -->
<div class="modal-bg" id="sheet-preview-modal" role="dialog" aria-modal="true" aria-labelledby="sp-modal-title">
  <div class="modal-box" style="max-width:820px;">
    <div class="modal-head">
      <div><h3 id="sp-modal-title" style="font-family:'Playfair Display',serif;font-size:19px;color:var(--forest);">A4 Sheet Preview</h3>
        <div style="font-size:12px;color:var(--mist);margin-top:2px;" id="sp-modal-info"></div></div>
      <button class="btn btn-ghost btn-xs" onclick="closeModal('sheet-preview-modal')" style="font-size:16px;" aria-label="Close">âœ•</button>
    </div>
    <div class="modal-body" style="background:#e8e8e8;">
      <div style="display:flex;justify-content:center;" id="sp-modal-sheet"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline btn-sm" onclick="closeModal('sheet-preview-modal')">Close</button>
      <button class="btn btn-honey btn-sm" onclick="closeModal('sheet-preview-modal');printA4Sheet()">ğŸ–¨ Print This Sheet</button>
      <button class="btn btn-forest btn-sm" onclick="closeModal('sheet-preview-modal');exportSheetPDF()">â¬‡ Export Sheet PDF</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL: SHORTCUTS â•â• -->
<div class="modal-bg" id="shortcuts-modal" role="dialog" aria-modal="true">
  <div class="modal-box" style="max-width:480px;">
    <div class="modal-head">
      <h3 style="font-family:'Playfair Display',serif;font-size:19px;color:var(--forest);">âŒ¨ Keyboard Shortcuts</h3>
      <button class="btn btn-ghost btn-xs" onclick="closeModal('shortcuts-modal')" style="font-size:16px;">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--cream);border-radius:6px;"><span style="font-size:12px;">Print Label</span><span class="kbt">Ctrl+P</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--cream);border-radius:6px;"><span style="font-size:12px;">Save Design</span><span class="kbt">Ctrl+S</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--cream);border-radius:6px;"><span style="font-size:12px;">Undo</span><span class="kbt">Ctrl+Z</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--cream);border-radius:6px;"><span style="font-size:12px;">Redo</span><span class="kbt">Ctrl+Y</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--cream);border-radius:6px;"><span style="font-size:12px;">Zoom In</span><span class="kbt">+</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--cream);border-radius:6px;"><span style="font-size:12px;">Zoom Out</span><span class="kbt">âˆ’</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--cream);border-radius:6px;"><span style="font-size:12px;">Reset Zoom</span><span class="kbt">0</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--cream);border-radius:6px;"><span style="font-size:12px;">Fit to View</span><span class="kbt">F</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--cream);border-radius:6px;"><span style="font-size:12px;">Print Sheet</span><span class="kbt">Ctrl+Shift+P</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--cream);border-radius:6px;"><span style="font-size:12px;">Close Modal</span><span class="kbt">Esc</span></div>
      </div>
    </div>
    <div class="modal-foot"><button class="btn btn-forest btn-sm" onclick="closeModal('shortcuts-modal')">Got it!</button></div>
  </div>
</div>

<!-- SIDEBAR OVERLAY -->
<div id="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<aside id="sidebar" role="complementary" aria-label="Label Settings">

  <!-- Brand Header -->
  <div class="sb-brand">
    <div style="display:flex;align-items:center;gap:12px;">
      <img src="https://res.cloudinary.com/dkj22lm1g/image/upload/v1766234881/Companya_Logo_-_Final_erhyg7.jpg"
           class="sb-logo" alt="GT Nutri Bites Logo" id="brand-logo-img"
           onerror="this.style.display='none'">
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:15px;line-height:1.15;font-weight:600;">GT Nutri Bites</div>
        <div style="font-size:9.5px;opacity:.7;margin-top:1px;letter-spacing:.04em;">Label Studio Pro</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:5px;">
        <button class="hist-btn" id="undo-btn" onclick="histUndo()" title="Undo (Ctrl+Z)" disabled>â†©</button>
        <button class="hist-btn" id="redo-btn" onclick="histRedo()" title="Redo (Ctrl+Y)" disabled>â†ª</button>
      </div>
    </div>
  </div>

  <!-- Tab Bar -->
  <div class="tab-bar" role="tablist">
    <div class="tab active" role="tab" data-tab="design" onclick="switchTab('design',this)">ğŸ¨ Design</div>
    <div class="tab" role="tab" data-tab="batch" onclick="switchTab('batch',this)">ğŸ“‹ Batch</div>
    <div class="tab" role="tab" data-tab="sheet" onclick="switchTab('sheet',this)">ğŸ“„ Sheet</div>
    <div class="tab" role="tab" data-tab="export" onclick="switchTab('export',this)">â¬‡ Export</div>
  </div>

  <!-- â•â• DESIGN TAB â•â• -->
  <div class="tab-panel active" id="panel-design">

    <!-- Label Type -->
    <div style="padding:10px 16px 6px;">
      <div class="subsec-title">Label Type</div>
      <div class="ltype-grid" id="ltype-grid"></div>
    </div>

    <!-- Label Size -->
    <div class="sec open" onclick="toggleSec(this)">Label Size <span class="chev">â–¾</span></div>
    <div class="sec-body open">
      <div class="field">
        <div class="flabel">Quick Sizes</div>
        <div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px;" id="size-pills">
          <div class="spill" data-w="2" data-h="1">2Ã—1"</div>
          <div class="spill active" data-w="4" data-h="2.5">4Ã—2.5"</div>
          <div class="spill" data-w="3" data-h="2">3Ã—2"</div>
          <div class="spill" data-w="4" data-h="4">4Ã—4"</div>
          <div class="spill" data-w="4" data-h="6">4Ã—6"</div>
          <div class="spill" data-w="6" data-h="4">6Ã—4"</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div>
            <div class="flabel">Width (in)</div>
            <input class="finput" type="number" id="lbl-w" value="4" step=".25" min="1" max="12">
          </div>
          <div>
            <div class="flabel">Height (in)</div>
            <input class="finput" type="number" id="lbl-h" value="2.5" step=".25" min=".5" max="12">
          </div>
        </div>
      </div>
    </div>

    <!-- Label Content -->
    <div class="sec open" onclick="toggleSec(this)">Label Content <span class="chev">â–¾</span></div>
    <div class="sec-body open" id="content-sec-body">
      <div id="dyn-fields"></div>
    </div>

    <!-- Logo Controls -->
    <div class="sec open" onclick="toggleSec(this)">Logo & Branding <span class="chev">â–¾</span></div>
    <div class="sec-body open">
      <div class="field">
        <div class="tog-row" style="margin-bottom:8px;">
          <span class="tog-label" style="font-weight:700;">Show Logo</span>
          <label class="tog"><input type="checkbox" id="show-logo" checked onchange="pushHistory();updatePreview()"><span class="tog-track"></span></label>
        </div>
        <div class="flabel" style="margin-bottom:5px;">Logo Position</div>
        <div class="lpg" id="logo-pos-grid">
          <div class="lpc" data-p="tl" onclick="setLogoPos('tl',this)"><div class="dot"></div></div>
          <div class="lpc" data-p="tc" onclick="setLogoPos('tc',this)"><div class="dot"></div></div>
          <div class="lpc" data-p="tr" onclick="setLogoPos('tr',this)"><div class="dot"></div></div>
          <div class="lpc" data-p="ml" onclick="setLogoPos('ml',this)"><div class="dot"></div></div>
          <div class="lpc a" data-p="tc-inline" onclick="setLogoPos('tc-inline',this)"><div class="dot"></div></div>
          <div class="lpc" data-p="mr" onclick="setLogoPos('mr',this)"><div class="dot"></div></div>
          <div class="lpc" data-p="bl" onclick="setLogoPos('bl',this)"><div class="dot"></div></div>
          <div class="lpc" data-p="bc" onclick="setLogoPos('bc',this)"><div class="dot"></div></div>
          <div class="lpc" data-p="br" onclick="setLogoPos('br',this)"><div class="dot"></div></div>
        </div>
        <div style="font-size:10px;color:var(--mist);margin-top:3px;text-align:center;">Centre = inline at top</div>
        <div style="margin-top:10px;">
          <div class="flabel">Logo Size <span class="rval" id="logo-size-v">72px</span></div>
          <input type="range" id="logo-size" min="24" max="180" value="72">
        </div>
        <div style="margin-top:10px;">
          <div class="flabel">Opacity <span class="rval" id="logo-op-v">100%</span></div>
          <input type="range" id="logo-op" min="20" max="100" value="100">
        </div>
        <div style="margin-top:10px;">
          <div class="flabel">Roundness <span class="rval" id="logo-rad-v">0%</span></div>
          <input type="range" id="logo-rad" min="0" max="50" value="0">
        </div>
        <div style="margin-top:10px;border-top:1px dashed var(--parchment);padding-top:10px;">
          <div class="flabel" style="margin-bottom:5px;">Custom Logo Upload</div>
          <div id="custom-logo-dz" onclick="document.getElementById('custom-logo-inp').click()"
               style="border:2px dashed var(--parchment);border-radius:8px;padding:10px;text-align:center;cursor:pointer;background:var(--cream);font-size:12px;color:var(--mist);transition:all .2s;"
               ondragover="event.preventDefault();this.style.borderColor='var(--forest)'"
               ondragleave="this.style.borderColor='var(--parchment)'"
               ondrop="handleCustomLogo(event)">
            <span id="custom-logo-label">ğŸ“ Drop or click to upload</span>
          </div>
          <input type="file" id="custom-logo-inp" accept="image/*" style="display:none" onchange="handleCustomLogoFile(this)">
          <button class="btn btn-ghost btn-xs" style="margin-top:4px;width:100%;color:var(--mist);" onclick="resetToDefaultLogo()">â†º Reset to default logo</button>
        </div>
      </div>
    </div>

    <!-- Colors & Style -->
    <div class="sec" onclick="toggleSec(this)">Colors & Style <span class="chev">â–¾</span></div>
    <div class="sec-body">
      <div class="field">
        <div class="flabel" style="margin-bottom:7px;">Theme Presets</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:12px;">
          <button class="btn btn-outline btn-xs" onclick="applyPreset('brand')">ğŸŒ¿ Brand</button>
          <button class="btn btn-outline btn-xs" onclick="applyPreset('dark')">ğŸŒ² Dark</button>
          <button class="btn btn-outline btn-xs" onclick="applyPreset('honey')">ğŸ¯ Honey</button>
          <button class="btn btn-outline btn-xs" onclick="applyPreset('ivory')">â˜ Ivory</button>
          <button class="btn btn-outline btn-xs" onclick="applyPreset('kraft')">ğŸ“¦ Kraft</button>
          <button class="btn btn-outline btn-xs" onclick="applyPreset('bold')">ğŸ’š Bold</button>
        </div>
        <div class="flabel">Background</div>
        <div class="cpick-row">
          <div class="cswatch-wrap"><input type="color" id="c-bg" value="#ffffff" oninput="syncColor('bg',this.value)"></div>
          <input class="finput" type="text" id="ct-bg" value="#ffffff" style="flex:1" oninput="syncColorText('bg',this.value)">
        </div>
        <div class="quick-swatches" id="qs-bg"></div>
      </div>
      <div class="field">
        <div class="flabel">Text Color</div>
        <div class="cpick-row">
          <div class="cswatch-wrap"><input type="color" id="c-txt" value="#1a1a0e" oninput="syncColor('txt',this.value)"></div>
          <input class="finput" type="text" id="ct-txt" value="#1a1a0e" style="flex:1" oninput="syncColorText('txt',this.value)">
        </div>
        <div class="quick-swatches" id="qs-txt"></div>
      </div>
      <div class="field">
        <div class="flabel">Accent Color</div>
        <div class="cpick-row">
          <div class="cswatch-wrap"><input type="color" id="c-acc" value="#1e4d2b" oninput="syncColor('acc',this.value)"></div>
          <input class="finput" type="text" id="ct-acc" value="#1e4d2b" style="flex:1" oninput="syncColorText('acc',this.value)">
        </div>
        <div class="quick-swatches" id="qs-acc"></div>
      </div>
    </div>

    <!-- Typography -->
    <div class="sec" onclick="toggleSec(this)">Typography <span class="chev">â–¾</span></div>
    <div class="sec-body">
      <div class="field">
        <div class="flabel">Font Family</div>
        <select class="finput" id="font-fam">
          <option value="'Nunito',sans-serif">Nunito (Default)</option>
          <option value="'Playfair Display',serif">Playfair Display</option>
          <option value="Georgia,serif">Georgia</option>
          <option value="'Times New Roman',serif">Times New Roman</option>
          <option value="'Courier New',monospace">Courier New</option>
          <option value="Arial,sans-serif">Arial</option>
          <option value="Verdana,sans-serif">Verdana</option>
        </select>
      </div>
      <div class="field">
        <div class="flabel">Font Size <span class="rval" id="fs-v">13px</span></div>
        <input type="range" id="font-sz" min="9" max="24" value="13">
      </div>
      <div class="field">
        <div class="flabel">Font Weight</div>
        <select class="finput" id="font-wt">
          <option value="300">Light</option>
          <option value="400" selected>Regular</option>
          <option value="600">Semibold</option>
          <option value="700">Bold</option>
        </select>
      </div>
      <div class="field">
        <div class="flabel">Text Align</div>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-outline btn-xs tal-btn active-align" data-a="left" onclick="setAlign('left',this)">â† Left</button>
          <button class="btn btn-outline btn-xs tal-btn" data-a="center" onclick="setAlign('center',this)">â†” Center</button>
          <button class="btn btn-outline btn-xs tal-btn" data-a="right" onclick="setAlign('right',this)">â†’ Right</button>
        </div>
      </div>
      <div class="field">
        <div class="flabel">Line Height <span class="rval" id="lh-v">1.4</span></div>
        <input type="range" id="line-h" min="10" max="28" value="14">
      </div>
    </div>

    <!-- Advanced -->
    <div class="sec" onclick="toggleSec(this)">Advanced <span class="chev">â–¾</span></div>
    <div class="sec-body">
      <div class="field">
        <div class="flabel">Padding <span class="rval" id="pad-v">14px</span></div>
        <input type="range" id="lbl-pad" min="4" max="40" value="14">
      </div>
      <div class="field">
        <div class="flabel">Corner Radius <span class="rval" id="cr-v">0px</span></div>
        <input type="range" id="corner-r" min="0" max="28" value="0">
      </div>
      <div class="field">
        <div class="flabel">Border Style</div>
        <select class="finput" id="bdr-style" onchange="updatePreview()">
          <option value="none">None</option>
          <option value="solid">Solid</option>
          <option value="dashed">Dashed</option>
          <option value="dotted">Dotted</option>
          <option value="double">Double</option>
        </select>
      </div>
      <div class="field">
        <div class="flabel">Border Width <span class="rval" id="bw-v">1px</span></div>
        <input type="range" id="bdr-w" min="1" max="6" value="1">
      </div>
      <div class="field">
        <div class="flabel">Border Color</div>
        <div class="cpick-row">
          <div class="cswatch-wrap"><input type="color" id="c-bdr" value="#1e4d2b" oninput="S.bdrColor=this.value;document.getElementById('ct-bdr').value=this.value;updatePreview()"></div>
          <input class="finput" type="text" id="ct-bdr" value="#1e4d2b" style="flex:1" oninput="if(/^#[0-9a-fA-F]{6}$/.test(this.value)){S.bdrColor=this.value;document.getElementById('c-bdr').value=this.value;updatePreview()}">
        </div>
      </div>
      <div class="field">
        <div class="tog-row">
          <span class="tog-label">Green leaf accent bar</span>
          <label class="tog"><input type="checkbox" id="leaf-bar" checked onchange="updatePreview()"><span class="tog-track"></span></label>
        </div>
        <div class="tog-row">
          <span class="tog-label">Website watermark</span>
          <label class="tog"><input type="checkbox" id="wm-tog" checked onchange="updatePreview()"><span class="tog-track"></span></label>
        </div>
      </div>
    </div>

    <!-- Save/Load -->
    <div class="sec" onclick="toggleSec(this)">Save & Load <span class="chev">â–¾</span></div>
    <div class="sec-body">
      <div class="field" style="display:flex;flex-direction:column;gap:7px;">
        <button class="btn btn-outline btn-sm btn-full" onclick="saveDesign()">ğŸ’¾ Save Design</button>
        <button class="btn btn-outline btn-sm btn-full" onclick="loadDesign()">ğŸ“‚ Load Saved</button>
        <button class="btn btn-danger btn-sm btn-full" onclick="clearAll()">ğŸ—‘ Reset Everything</button>
      </div>
    </div>

  </div><!-- /panel-design -->

  <!-- â•â• BATCH TAB â•â• -->
  <div class="tab-panel" id="panel-batch">
    <div style="padding:12px 16px;">
      <p style="font-size:12px;color:var(--mist);line-height:1.6;margin-bottom:14px;">Process multiple orders at once. Download a CSV template, fill it in, then upload to generate all labels.</p>

      <!-- Step 1 -->
      <div class="step-box">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <div class="step-badge">â‘ </div>
          <div class="subsec-title" style="margin:0;">Select Label Type</div>
        </div>
        <select class="finput" id="batch-type"><option value="">â€” Choose a label type â€”</option></select>
      </div>

      <!-- Step 2 -->
      <div class="step-box">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <div class="step-badge">â‘¡</div>
          <div class="subsec-title" style="margin:0;">Get CSV Template</div>
        </div>
        <button class="btn btn-forest btn-sm btn-full" onclick="openModal('csv-modal')">ğŸ“„ View & Download Template</button>
      </div>

      <!-- Step 3 -->
      <div class="step-box">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <div class="step-badge">â‘¢</div>
          <div class="subsec-title" style="margin:0;">Upload Filled CSV</div>
        </div>
        <div class="batch-dz" id="batch-dz" onclick="document.getElementById('batch-inp').click()"
             ondragover="event.preventDefault();this.classList.add('over')"
             ondragleave="this.classList.remove('over')"
             ondrop="handleBatchDrop(event)">
          <div style="font-size:24px;margin-bottom:6px;">ğŸŒ±</div>
          <div style="font-weight:700;font-size:13px;color:var(--forest);">Drop CSV here</div>
          <div style="font-size:11px;color:var(--mist);margin-top:2px;">or click to browse</div>
        </div>
        <input type="file" id="batch-inp" accept=".csv" style="display:none" onchange="handleBatchFile(this)">
      </div>

      <!-- Batch Status -->
      <div id="batch-status" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;">
          <span style="font-weight:700;font-size:13px;color:var(--forest);" id="batch-count-lbl">0 labels</span>
          <button class="btn btn-ghost btn-xs" onclick="clearBatch()">âœ• Clear</button>
        </div>
        <div id="batch-prog"><div id="batch-fill"></div></div>
        <div id="batch-list" style="max-height:240px;overflow-y:auto;"></div>
      </div>

      <!-- Batch Actions -->
      <div style="display:flex;flex-direction:column;gap:7px;margin-top:10px;">
        <button class="btn btn-honey btn-sm btn-full" onclick="openBatchPreview()">ğŸ‘ Preview All Labels</button>
        <button class="btn btn-sheet btn-sm btn-full" onclick="switchTab('sheet',document.querySelector('[data-tab=sheet]'))">ğŸ“„ Print on A4 Sheet</button>
        <button class="btn btn-forest btn-sm btn-full" onclick="batchPrint()">ğŸ–¨ Print All (Individual Pages)</button>
        <button class="btn btn-forest btn-sm btn-full" onclick="batchPDF()">â¬‡ Export All as PDF</button>
        <button class="btn btn-outline btn-sm btn-full" onclick="batchPNGs()">â¬‡ Export as PNGs</button>
      </div>

      <div style="margin-top:12px;padding:9px;background:rgba(30,77,43,.06);border-radius:8px;font-size:11px;color:var(--mist);line-height:1.6;">
        ğŸ’¡ Your Design tab settings apply to all batch labels. Customise look in Design before batch exporting.
      </div>
    </div>
  </div><!-- /panel-batch -->

  <!-- â•â• SHEET TAB (NEW) â•â• -->
  <div class="tab-panel" id="panel-sheet">
    <div style="padding:12px 16px;">

      <div style="background:linear-gradient(135deg,rgba(30,77,43,.08),rgba(200,150,30,.06));border:1px solid rgba(30,77,43,.15);border-radius:10px;padding:12px;margin-bottom:14px;">
        <div style="font-weight:800;font-size:13px;color:var(--forest);margin-bottom:4px;">ğŸ“„ A4 Sticker Sheet Printer</div>
        <div style="font-size:11px;color:var(--mist);line-height:1.5;">Arrange multiple labels on a single A4 sheet (210Ã—297mm). Print and cut out your labels. Works for both single repeated labels and batch CSV labels.</div>
      </div>

      <!-- Source -->
      <div class="step-box">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><div class="step-badge">â‘ </div><div class="subsec-title" style="margin:0;">Label Source</div></div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;border:1.5px solid var(--parchment);border-radius:8px;transition:.15s;" id="src-single-lbl" onclick="setSheetSource('single')">
            <input type="radio" name="sheet-src" value="single" checked style="accent-color:var(--forest);">
            <div><div style="font-weight:700;font-size:12.5px;">Current Label (Repeated)</div><div style="font-size:11px;color:var(--mist);">Print the label currently shown in preview</div></div>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;border:1.5px solid var(--parchment);border-radius:8px;transition:.15s;" id="src-batch-lbl" onclick="setSheetSource('batch')">
            <input type="radio" name="sheet-src" value="batch" style="accent-color:var(--forest);">
            <div><div style="font-weight:700;font-size:12.5px;">Batch Labels <span id="batch-src-count" class="badge badge-forest" style="margin-left:4px;"></span></div><div style="font-size:11px;color:var(--mist);">Use labels from uploaded CSV</div></div>
          </label>
        </div>
      </div>

      <!-- Sheet Config -->
      <div class="step-box">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><div class="step-badge">â‘¡</div><div class="subsec-title" style="margin:0;">Sheet Layout</div></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
          <div>
            <div class="flabel">Columns</div>
            <input class="finput" type="number" id="sheet-cols" value="2" min="1" max="6" oninput="updateSheetPreview()">
          </div>
          <div>
            <div class="flabel">Rows</div>
            <input class="finput" type="number" id="sheet-rows" value="4" min="1" max="10" oninput="updateSheetPreview()">
          </div>
        </div>
        <div style="margin-bottom:8px;">
          <div class="flabel">Page Margin (mm) <span class="rval" id="sheet-margin-v">8mm</span></div>
          <input type="range" id="sheet-margin" min="2" max="20" value="8" oninput="document.getElementById('sheet-margin-v').textContent=this.value+'mm';updateSheetPreview()">
        </div>
        <div style="margin-bottom:8px;">
          <div class="flabel">Gap Between Labels (mm) <span class="rval" id="sheet-gap-v">4mm</span></div>
          <input type="range" id="sheet-gap" min="0" max="15" value="4" oninput="document.getElementById('sheet-gap-v').textContent=this.value+'mm';updateSheetPreview()">
        </div>
        <div class="tog-row" style="margin-bottom:4px;">
          <span class="tog-label">Show cutting guides</span>
          <label class="tog"><input type="checkbox" id="sheet-cut-marks" checked onchange="updateSheetPreview()"><span class="tog-track"></span></label>
        </div>
        <div class="tog-row">
          <span class="tog-label">Page orientation: Landscape</span>
          <label class="tog"><input type="checkbox" id="sheet-landscape" onchange="updateSheetPreview()"><span class="tog-track"></span></label>
        </div>
      </div>

      <!-- Single source: copy count -->
      <div id="sheet-copy-box" class="step-box">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><div class="step-badge">â‘¢</div><div class="subsec-title" style="margin:0;">Copies</div></div>
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="font-size:12.5px;color:var(--ink);">Number of label copies on sheet:</span>
          <input class="copy-input" type="number" id="sheet-copies" value="8" min="1" max="100" oninput="updateSheetPreview()">
        </div>
        <div style="font-size:11px;color:var(--mist);margin-top:5px;">Auto-fills grid. Excess cells left blank.</div>
      </div>

      <!-- Sheet Info -->
      <div id="sheet-info" style="background:rgba(30,77,43,.06);border-radius:8px;padding:10px;font-size:12px;color:var(--mist);margin-bottom:12px;line-height:1.7;">
        <span id="sheet-info-text">Configure layout above to see sheet details.</span>
      </div>

      <!-- Actions -->
      <div style="display:flex;flex-direction:column;gap:7px;">
        <button class="btn btn-honey btn-sm btn-full" onclick="previewSheetModal()">ğŸ‘ Preview Sheet</button>
        <button class="btn btn-sheet btn-sm btn-full" onclick="printA4Sheet()">ğŸ–¨ Print A4 Sheet</button>
        <button class="btn btn-forest btn-sm btn-full" onclick="exportSheetPDF()">â¬‡ Export Sheet as PDF</button>
      </div>

      <div style="margin-top:12px;padding:9px;background:rgba(200,150,30,.08);border:1px solid rgba(200,150,30,.2);border-radius:8px;font-size:11px;color:var(--bark);line-height:1.6;">
        ğŸ–¨ <strong>Tip:</strong> Use A4 sticker paper (210Ã—297mm) for best results. Set printer to "Fit to page" or "Actual size". After printing, cut along the guide lines.
      </div>
    </div>
  </div><!-- /panel-sheet -->

  <!-- â•â• EXPORT TAB â•â• -->
  <div class="tab-panel" id="panel-export">
    <div style="padding:12px 16px;">
      <p style="font-size:12px;color:var(--mist);line-height:1.6;margin-bottom:14px;">Export the currently previewed label as print-ready files.</p>

      <div class="subsec-title">Single Label</div>
      <div style="display:flex;flex-direction:column;gap:7px;margin-bottom:18px;">
        <div style="display:flex;gap:7px;align-items:center;">
          <button class="btn btn-forest btn-sm" style="flex:1;" onclick="printSingle()">ğŸ–¨ Print</button>
          <span style="font-size:11px;color:var(--mist);">Copies:</span>
          <input class="copy-input" type="number" id="single-copies" value="1" min="1" max="100" style="width:52px;">
        </div>
        <button class="btn btn-honey btn-sm btn-full" onclick="dlPDF()">â¬‡ Download PDF</button>
        <button class="btn btn-outline btn-sm btn-full" onclick="dlPNG()">â¬‡ Download PNG</button>
      </div>

      <div style="border-top:1px solid var(--cream-d);padding-top:14px;margin-bottom:14px;">
        <div class="subsec-title">PDF Options</div>
        <div class="flabel" style="margin-bottom:4px;">Export Quality</div>
        <select class="finput" id="exp-quality" style="margin-bottom:10px;">
          <option value="1">Standard (72 DPI)</option>
          <option value="2" selected>High (144 DPI)</option>
          <option value="3">Professional (216 DPI)</option>
          <option value="4">Maximum (288 DPI)</option>
        </select>
      </div>

      <div style="border-top:1px solid var(--cream-d);padding-top:14px;">
        <div class="subsec-title">Quick Actions</div>
        <div style="display:flex;flex-direction:column;gap:7px;">
          <button class="btn btn-outline btn-sm btn-full" onclick="openModal('shortcuts-modal')">âŒ¨ Keyboard Shortcuts</button>
          <button class="btn btn-outline btn-sm btn-full" onclick="copyLabelHTML()">ğŸ“‹ Copy Label HTML</button>
        </div>
      </div>
    </div>
  </div><!-- /panel-export -->

  <!-- Bottom Bar -->
  <div style="padding:10px 16px;border-top:1px solid var(--cream-d);margin-top:auto;display:flex;gap:8px;align-items:center;background:var(--cream);">
    <label class="tog" title="Dark mode"><input type="checkbox" id="dark-tog" onchange="toggleDark(this)"><span class="tog-track"></span></label>
    <span style="font-size:12px;color:var(--mist);">Dark Mode</span>
    <span style="margin-left:auto;font-size:10px;color:var(--mist);font-family:'DM Mono',monospace;" id="autosave-lbl"></span>
  </div>

</aside><!-- /sidebar -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header id="header" role="banner">
  <div style="display:flex;align-items:center;gap:12px;">
    <button class="btn btn-ghost mob-only" onclick="toggleSidebar()" style="color:rgba(255,255,255,.9);padding:5px 9px;font-size:17px;" aria-label="Toggle sidebar">â˜°</button>
    <div>
      <span style="font-family:'Playfair Display',serif;color:#fff;font-size:17px;font-weight:600;letter-spacing:.01em;">Label Preview</span>
      <span id="type-badge" style="margin-left:9px;background:rgba(255,255,255,.15);color:#fff;padding:2px 10px;border-radius:20px;font-size:10px;font-weight:800;letter-spacing:.04em;font-family:'Nunito',sans-serif;backdrop-filter:blur(4px);">Thank You</span>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:8px;">
    <span style="font-size:10.5px;color:rgba(255,255,255,.65);font-family:'DM Mono',monospace;" id="size-hdr">4" Ã— 2.5"</span>
    <button class="btn btn-ghost" onclick="printSingle()" style="color:rgba(255,255,255,.9);padding:6px 11px;font-size:12px;" title="Print (Ctrl+P)">ğŸ–¨ Print</button>
    <button class="btn" onclick="printA4Sheet()" style="background:rgba(255,255,255,.15);color:#fff;padding:6px 11px;font-size:12px;border:1px solid rgba(255,255,255,.25);" title="Print A4 Sheet (Ctrl+Shift+P)">ğŸ“„ Sheet</button>
    <button class="btn" onclick="dlPDF()" style="background:var(--honey);color:#fff;padding:6px 13px;font-size:12px;" title="Download PDF">â¬‡ PDF</button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main id="main">
  <!-- Preview -->
  <div id="preview-area">
    <div style="position:relative;" id="zoom-wrap">
      <div id="label-canvas" role="img" aria-label="Label preview">
        <div id="label-inner"></div>
      </div>
      <!-- Zoom Bar -->
      <div class="zoom-bar">
        <button class="zbtn" onclick="zoom(-0.1)" title="Zoom out">âˆ’</button>
        <span class="zlbl" id="zoom-lbl">100%</span>
        <button class="zbtn" onclick="zoom(0.1)" title="Zoom in">+</button>
        <button class="zbtn" onclick="zoomReset()" title="Reset zoom" style="font-size:10px;">âŠ™</button>
        <button class="zbtn" onclick="zoomFit()" title="Fit to view" style="font-size:10px;">â¤¢</button>
      </div>
    </div>
  </div>

  <!-- Brand Tips Section -->
  <section style="background:var(--white);border-top:2px solid var(--cream-d);padding:32px 36px 48px;">
    <div style="max-width:940px;margin:0 auto;">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:8px;">
        <img src="https://res.cloudinary.com/dkj22lm1g/image/upload/v1766234881/Companya_Logo_-_Final_erhyg7.jpg"
             style="height:44px;object-fit:contain;border-radius:8px;" alt="GT Nutri Bites" onerror="this.style.display='none'">
        <div>
          <h2 style="font-family:'Playfair Display',serif;font-size:20px;color:var(--forest);">GT Nutri Bites Label Studio Pro</h2>
          <div style="font-size:12px;color:var(--mist);margin-top:2px;">Professional label generator for premium nuts & seeds â€” now with A4 sticker sheet printing</div>
        </div>
      </div>
      <div style="height:2px;background:linear-gradient(90deg,var(--forest),var(--honey),transparent);border-radius:1px;margin:14px 0 20px;"></div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;">
        <div class="tip-card"><div style="font-size:20px;margin-bottom:6px;">ğŸŒ¿</div><div style="font-weight:700;font-size:13px;color:var(--forest);margin-bottom:3px;">Brand Consistency</div><div style="font-size:12px;color:var(--mist);line-height:1.6;">Use the Brand preset for GT Nutri Bites green & honey palette across all labels.</div></div>
        <div class="tip-card"><div style="font-size:20px;margin-bottom:6px;">ğŸ“„</div><div style="font-weight:700;font-size:13px;color:var(--forest);margin-bottom:3px;">A4 Sheet Printing <span class="badge badge-new">NEW</span></div><div style="font-size:12px;color:var(--mist);line-height:1.6;">Use the Sheet tab to print multiple labels on one A4 sticker paper â€” just cut and apply!</div></div>
        <div class="tip-card"><div style="font-size:20px;margin-bottom:6px;">ğŸ“‹</div><div style="font-weight:700;font-size:13px;color:var(--forest);margin-bottom:3px;">Batch Printing</div><div style="font-size:12px;color:var(--mist);line-height:1.6;">Upload a CSV to generate labels for all your orders at once, then export or print.</div></div>
        <div class="tip-card"><div style="font-size:20px;margin-bottom:6px;">ğŸ–¨</div><div style="font-weight:700;font-size:13px;color:var(--forest);margin-bottom:3px;">Print Quality</div><div style="font-size:12px;color:var(--mist);line-height:1.6;">Set export quality to Professional (216 DPI) in Export tab before printing for crisp results.</div></div>
        <div class="tip-card"><div style="font-size:20px;margin-bottom:6px;">â†©â†ª</div><div style="font-weight:700;font-size:13px;color:var(--forest);margin-bottom:3px;">Undo / Redo <span class="badge badge-new">NEW</span></div><div style="font-size:12px;color:var(--mist);line-height:1.6;">Made a mistake? Use Ctrl+Z to undo and Ctrl+Y to redo your last 10 changes.</div></div>
        <div class="tip-card"><div style="font-size:20px;margin-bottom:6px;">âœ¨</div><div style="font-weight:700;font-size:13px;color:var(--forest);margin-bottom:3px;">Customer Delight</div><div style="font-size:12px;color:var(--mist);line-height:1.6;">Include a personalised thank-you label with every order. Small details create loyal customers.</div></div>
      </div>
    </div>
  </section>
</main>

<!-- Print Root -->
<div id="print-root"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

/* â”€â”€ CONSTANTS â”€â”€ */
const LOGO_URL = 'https://res.cloudinary.com/dkj22lm1g/image/upload/v1766234881/Companya_Logo_-_Final_erhyg7.jpg';
const BRAND = { name:'GT Nutri Bites', tagline:'Premium Nuts & Seeds', website:'gt-nutri-bites.github.io', email:'info@gtnutribites.com', phone:'+94 77 000 0000', address:'Colombo, Sri Lanka' };
const DPI = 96;
const PX_PER_MM = 3.7795275591; // 96dpi to mm

/* â”€â”€ LABEL TYPES â”€â”€ */
const TYPES = [
  { id:'thankyou',  name:'Thank You',     ico:'ğŸ™' },
  { id:'welcome',   name:'Welcome',       ico:'ğŸ‘‹' },
  { id:'delivery',  name:'Delivery',      ico:'ğŸšš' },
  { id:'del-ret',   name:'Del + Return',  ico:'ğŸ”„' },
  { id:'product',   name:'Product Info',  ico:'ğŸŒ°' },
  { id:'contact',   name:'Contact',       ico:'ğŸ“' },
  { id:'promo',     name:'Promo / Offer', ico:'ğŸ' },
  { id:'ingredient',name:'Ingredients',  ico:'ğŸ¥—' },
];

/* â”€â”€ FIELDS â”€â”€ */
const FIELDS = {
  thankyou: [
    { id:'customer-name', label:"Customer's Name",      ph:'Jane',                           req:true  },
    { id:'order-no',      label:'Order Number',          ph:'ORD-2024-001',                   req:false },
    { id:'thank-msg',     label:'Thank You Message',     ph:'Thank you so much for your order! Your support means the world to us. ğŸŒ¿', req:false, ta:true },
    { id:'discount-code', label:'Discount Code',         ph:'THANKS10',                       req:false },
    { id:'discount-note', label:'Discount Description',  ph:'10% off your next order',        req:false },
    { id:'social',        label:'Social Media Handle',   ph:'@gtnutribites',                  req:false },
  ],
  welcome: [
    { id:'customer-name', label:"Customer's Name",      ph:'Jane Smith',                     req:false },
    { id:'welcome-msg',   label:'Welcome Message',       ph:"Welcome to the GT Nutri Bites family! ğŸŒ± We're thrilled to have you with us.", req:false, ta:true },
    { id:'offer',         label:'Welcome Offer',         ph:'10% off your first order â€” use code: WELCOME10', req:false },
    { id:'social',        label:'Social Handle',         ph:'@gtnutribites',                  req:false },
  ],
  delivery: [
    { id:'sender-name',   label:'From: Business Name',  ph:'GT Nutri Bites',                 req:true  },
    { id:'sender-addr',   label:'From: Address',         ph:'Colombo, Sri Lanka',             req:false },
    { id:'recv-name',     label:'To: Customer Name',    ph:'Jane Smith',                     req:true  },
    { id:'recv-addr',     label:'To: Delivery Address',  ph:'123 Main St, City',              req:true,  ta:true },
    { id:'order-no',      label:'Order Number',          ph:'ORD-2024-001',                   req:false },
    { id:'tracking',      label:'Tracking Number',       ph:'TRK-0000000',                    req:false },
    { id:'method',        label:'Delivery Method',       ph:'Standard Shipping (3â€“5 days)',   req:false },
    { id:'weight',        label:'Package Weight',        ph:'250g',                           req:false },
  ],
  'del-ret': [
    { id:'sender-name',   label:'Company Name',          ph:'GT Nutri Bites',                 req:true  },
    { id:'recv-name',     label:'Customer Name',         ph:'Jane Smith',                     req:true  },
    { id:'recv-addr',     label:'Delivery Address',      ph:'123 Main St, City',              req:true,  ta:true },
    { id:'order-no',      label:'Order Number',          ph:'ORD-2024-001',                   req:false },
    { id:'del-date',      label:'Est. Delivery',         ph:'Jan 20â€“22, 2025',                req:false },
    { id:'ret-addr',      label:'Return To Address',     ph:'GT Nutri Bites Returns\nColombo, Sri Lanka', req:false, ta:true },
    { id:'ret-by',        label:'Return Deadline',       ph:'30 days from delivery',          req:false },
    { id:'ret-policy',    label:'Return Policy Note',    ph:'Items must be unopened and in original condition.', req:false },
  ],
  product: [
    { id:'prod-name',    label:'Product Name',          ph:'Organic Raw Almonds',             req:true  },
    { id:'variant',      label:'Variant / Flavour',     ph:'Raw Â· Unsalted',                  req:false },
    { id:'weight',       label:'Net Weight',            ph:'500g / 17.6oz',                   req:true  },
    { id:'desc',         label:'Description',           ph:'Premium California almonds, raw & unsalted.', req:false, ta:true },
    { id:'ingredients',  label:'Ingredients',           ph:'100% Organic Almonds',            req:false },
    { id:'allergens',    label:'Allergens / Contains',  ph:'Contains: Tree Nuts (Almonds)',   req:false },
    { id:'storage',      label:'Storage Instructions',  ph:'Store in a cool, dry place.',      req:false },
    { id:'best-before',  label:'Best Before',           ph:'Dec 2025',                        req:false },
    { id:'batch-no',     label:'Batch Number',          ph:'LOT-2024-001',                    req:false },
    { id:'price',        label:'Price',                 ph:'Rs. 6,267',                       req:false },
    { id:'sku',          label:'SKU / Item Code',       ph:'GNB-ALM-500',                     req:false },
    { id:'cert',         label:'Certifications',        ph:'100% Organic Â· Sustainably Sourced', req:false },
  ],
  contact: [
    { id:'comp-name',  label:'Company / Person Name',  ph:'GT Nutri Bites',                  req:true  },
    { id:'phone',      label:'Phone',                   ph:'+94 77 000 0000',                 req:false },
    { id:'email',      label:'Email',                   ph:'info@gtnutribites.com',            req:false },
    { id:'website',    label:'Website',                 ph:'gt-nutri-bites.github.io',        req:false },
    { id:'address',    label:'Address',                 ph:'Colombo, Sri Lanka',              req:false },
    { id:'hours',      label:'Business Hours',          ph:'Monâ€“Fri: 9AMâ€“6PM',               req:false },
    { id:'social',     label:'Social Media',            ph:'@gtnutribites',                   req:false },
    { id:'cta',        label:'Call to Action',          ph:'Scan to shop online!',            req:false },
  ],
  promo: [
    { id:'headline',   label:'Headline / Offer Title', ph:'ğŸ‰ Special Offer!',               req:true  },
    { id:'code',       label:'Promo Code',              ph:'NUTS20',                          req:false },
    { id:'discount',   label:'Discount Amount',         ph:'20% OFF',                         req:false },
    { id:'details',    label:'Offer Details',           ph:'Valid on orders over Rs. 2,000. Limited time offer.', req:false, ta:true },
    { id:'expiry',     label:'Expiry / Valid Until',    ph:'Valid until Dec 31, 2025',        req:false },
    { id:'social',     label:'Social Handle',           ph:'@gtnutribites',                   req:false },
  ],
  ingredient: [
    { id:'prod-name',  label:'Product Name',           ph:'Organic Raw Almonds',             req:true  },
    { id:'serving',    label:'Serving Size',            ph:'30g (about 23 almonds)',          req:false },
    { id:'calories',   label:'Calories per Serving',   ph:'174 kcal',                        req:false },
    { id:'protein',    label:'Protein',                 ph:'6.3g',                            req:false },
    { id:'fat',        label:'Total Fat',               ph:'15.1g',                           req:false },
    { id:'carbs',      label:'Total Carbs',             ph:'5.9g',                            req:false },
    { id:'fiber',      label:'Dietary Fiber',           ph:'2.7g',                            req:false },
    { id:'sugar',      label:'Sugars',                  ph:'1.5g',                            req:false },
    { id:'sodium',     label:'Sodium',                  ph:'0mg',                             req:false },
    { id:'vitamins',   label:'Key Vitamins & Minerals', ph:'Vitamin E, Magnesium, Calcium',  req:false },
    { id:'cert',       label:'Certifications',          ph:'100% Organic Â· Vegan Â· Gluten Free', req:false },
  ],
};

/* â”€â”€ CSV SAMPLES â”€â”€ */
const CSV_SAMPLES = {
  thankyou:   [['Jane','ORD-2024-001','Thank you so much for your order! ğŸŒ¿','THANKS10','10% off your next order','@gtnutribites'],
               ['Amal','ORD-2024-002','We truly appreciate your support. Enjoy every bite!','THANKS10','10% off your next order','@gtnutribites']],
  welcome:    [['Jane Smith','Welcome to the GT Nutri Bites family! ğŸŒ±','10% off your first order â€” use code: WELCOME10','@gtnutribites']],
  delivery:   [['GT Nutri Bites','Colombo Sri Lanka','Jane Smith','123 Main St, Colombo 03','ORD-2024-001','TRK-1234567','Standard (3â€“5 days)','500g'],
               ['GT Nutri Bites','Colombo Sri Lanka','Amal Perera','45 Lake Rd, Kandy','ORD-2024-002','TRK-1234568','Express (1â€“2 days)','250g']],
  'del-ret':  [['GT Nutri Bites','Jane Smith','123 Main St Colombo 03','ORD-2024-001','Jan 20â€“22 2025','GT Nutri Bites Returns\nColombo Sri Lanka','Feb 20 2025','Items must be unopened.']],
  product:    [['Organic Raw Almonds','Raw Â· Unsalted','500g / 17.6oz','Premium California almonds.','100% Organic Almonds','Contains: Tree Nuts','Store in cool dry place','Dec 2025','LOT-2024-001','Rs. 6267','GNB-ALM-500','100% Organic'],
               ['Chia Seeds','','400g','Omega-3 rich superfood.','100% Chia Seeds','','Cool dry place','Nov 2025','LOT-2024-002','Rs. 4947','GNB-CHI-400','100% Organic']],
  contact:    [['GT Nutri Bites','+94 77 000 0000','info@gtnutribites.com','gt-nutri-bites.github.io','Colombo Sri Lanka','Monâ€“Fri 9AMâ€“6PM','@gtnutribites','Scan to shop!']],
  promo:      [['ğŸ‰ Limited Time Offer!','NUTS20','20% OFF','Valid on all nut selections over Rs. 2000.','Valid until Dec 31 2025','@gtnutribites']],
  ingredient: [['Organic Raw Almonds','30g (~23 almonds)','174 kcal','6.3g','15.1g','5.9g','2.7g','1.5g','0mg','Vitamin E, Magnesium','100% Organic Â· Vegan']],
};

/* â”€â”€ STATE â”€â”€ */
let S = {
  type:'thankyou', logoPos:'tc-inline', logoSize:72, logoOp:100, logoRad:0,
  showLogo:true, customLogo:null, bgColor:'#ffffff', txtColor:'#1a1a0e', accColor:'#1e4d2b',
  bdrColor:'#1e4d2b', fontFam:"'Nunito',sans-serif", fontSize:13, fontWt:'400',
  align:'left', lineH:1.4, padding:14, cornerR:0, bdrStyle:'none', bdrW:1,
  leafBar:true, watermark:true, fields:{}, width:4, height:2.5, zoom:1,
};

/* â”€â”€ HISTORY (UNDO/REDO) â”€â”€ */
let history = [], histIdx = -1;
function pushHistory() {
  const snap = JSON.stringify(S);
  if (histIdx < history.length - 1) history = history.slice(0, histIdx + 1);
  history.push(snap);
  if (history.length > 20) history.shift();
  histIdx = history.length - 1;
  updateHistBtns();
}
function histUndo() {
  if (histIdx <= 0) return;
  histIdx--;
  S = JSON.parse(history[histIdx]);
  restoreState(); updateHistBtns();
}
function histRedo() {
  if (histIdx >= history.length - 1) return;
  histIdx++;
  S = JSON.parse(history[histIdx]);
  restoreState(); updateHistBtns();
}
function updateHistBtns() {
  document.getElementById('undo-btn').disabled = histIdx <= 0;
  document.getElementById('redo-btn').disabled = histIdx >= history.length - 1;
}
function restoreState() {
  buildTypeGrid(); buildDynFields(); syncFieldsToUI();
  syncUIFromState(); applyZoom(); updateSizeHdr(); updatePreview();
}

/* â”€â”€ BATCH DATA â”€â”€ */
let batchData = [];
let csvTypeSel = null;
let debTimer   = null;
let sheetSrc   = 'single';

/* â”€â”€ SWATCHES â”€â”€ */
const SWATCHES = {
  bg:  ['#ffffff','#faf8f2','#e8e2d0','#1a2d1a','#1e4d2b','#f5f0e8','#d4e8c8','#2d1e06'],
  txt: ['#1a1a0e','#1e4d2b','#3d2b1a','#ffffff','#c8961e','#2d5a1b','#4a2010','#6b7a5e'],
  acc: ['#1e4d2b','#c8961e','#2d6b3c','#88b878','#3d2b1a','#5a8a4a','#a87a14','#163820'],
};

const PRESETS = {
  brand:  { bg:'#ffffff', txt:'#1a1a0e', acc:'#1e4d2b' },
  dark:   { bg:'#163820', txt:'#faf8f2', acc:'#c8961e' },
  honey:  { bg:'#fef9ec', txt:'#3d2b1a', acc:'#c8961e' },
  ivory:  { bg:'#faf8f2', txt:'#1a1a0e', acc:'#5a8a4a' },
  kraft:  { bg:'#e8dfc8', txt:'#2d1e06', acc:'#1e4d2b' },
  bold:   { bg:'#1e4d2b', txt:'#ffffff', acc:'#c8961e' },
};

/* â”€â”€ INIT â”€â”€ */
function init() {
  buildTypeGrid();
  buildBatchTypeSelect();
  buildCSVTypeGrid();
  buildSwatches();
  bindEvents();
  buildDynFields();
  prefillBrandFields();
  pushHistory();
  updatePreview();
  updateSheetPreview();
  // Auto-load saved
  autoLoadDesign();
  // Auto-save interval
  setInterval(()=>{ autoSaveDesign(); }, 30000);
}

function buildTypeGrid() {
  const g = document.getElementById('ltype-grid');
  g.innerHTML = '';
  TYPES.forEach(t => {
    const el = document.createElement('div');
    el.className = 'ltype-card' + (t.id === S.type ? ' active' : '');
    el.innerHTML = `<span class="ico">${t.ico}</span>${t.name}`;
    el.dataset.id = t.id;
    el.setAttribute('role','radio');
    el.setAttribute('tabindex','0');
    el.setAttribute('aria-label', t.name + ' label');
    el.onclick = () => selectType(t.id);
    el.onkeydown = e => { if(e.key==='Enter'||e.key===' ') selectType(t.id); };
    g.appendChild(el);
  });
}

function buildBatchTypeSelect() {
  const sel = document.getElementById('batch-type');
  sel.innerHTML = '<option value="">â€” Choose a label type â€”</option>';
  TYPES.forEach(t => {
    const o = document.createElement('option');
    o.value = t.id; o.textContent = t.ico + ' ' + t.name;
    sel.appendChild(o);
  });
}

function buildCSVTypeGrid() {
  const g = document.getElementById('csv-type-grid');
  g.innerHTML = '';
  TYPES.forEach(t => {
    const el = document.createElement('div');
    el.style.cssText = 'border:1.5px solid var(--parchment);border-radius:8px;padding:9px 7px;cursor:pointer;text-align:center;font-size:10.5px;font-weight:700;transition:all .2s;background:var(--cream);color:var(--mist);';
    el.innerHTML = `<div style="font-size:17px;margin-bottom:3px;">${t.ico}</div>${t.name}`;
    el.onclick = () => selectCSVType(t.id, el);
    g.appendChild(el);
  });
}

function buildSwatches() {
  ['bg','txt','acc'].forEach(k => {
    const id = k==='bg'?'qs-bg':k==='txt'?'qs-txt':'qs-acc';
    const container = document.getElementById(id);
    SWATCHES[k].forEach(hex => {
      const el = document.createElement('div');
      el.className = 'qswatch';
      el.style.background = hex;
      el.title = hex;
      el.onclick = () => applyColor(k, hex);
      container.appendChild(el);
    });
  });
}

function buildDynFields() {
  const container = document.getElementById('dyn-fields');
  container.innerHTML = '';
  const defs = FIELDS[S.type] || [];
  if (!defs.length) {
    container.innerHTML = '<div style="padding:0 16px 10px;font-size:12px;color:var(--mist);">No content fields for this label type.</div>';
    return;
  }
  defs.forEach(f => {
    const wrap = document.createElement('div');
    wrap.className = 'field';
    const lbl = document.createElement('div');
    lbl.className = 'flabel';
    lbl.innerHTML = f.label + (f.req ? ' <span class="req">*</span>' : '');
    wrap.appendChild(lbl);
    const inp = f.ta ? document.createElement('textarea') : document.createElement('input');
    inp.className = 'finput';
    inp.placeholder = f.ph;
    if (!f.ta) inp.type = 'text';
    if (f.ta) inp.rows = 2;
    inp.value = S.fields[f.id] !== undefined ? S.fields[f.id] : '';
    inp.dataset.fid = f.id;
    inp.setAttribute('aria-label', f.label);
    inp.addEventListener('input', () => { S.fields[f.id] = inp.value; debUpdate(); });
    inp.addEventListener('change', () => pushHistory());
    wrap.appendChild(inp);
    container.appendChild(wrap);
  });
}

function prefillBrandFields() {
  if (S.type === 'contact' && !S.fields['comp-name']) {
    Object.assign(S.fields, { 'comp-name':BRAND.name, 'phone':BRAND.phone, 'email':BRAND.email, 'website':BRAND.website, 'address':BRAND.address, 'social':'@gtnutribites', 'cta':'Scan to shop online!' });
  }
  if ((S.type==='delivery'||S.type==='del-ret') && !S.fields['sender-name']) {
    S.fields['sender-name'] = BRAND.name;
    S.fields['sender-addr'] = BRAND.address;
  }
  if (S.type==='thankyou' && !S.fields['social']) S.fields['social'] = '@gtnutribites';
}

function syncFieldsToUI() {
  document.querySelectorAll('#dyn-fields [data-fid]').forEach(inp => {
    inp.value = S.fields[inp.dataset.fid] || '';
  });
}

function syncUIFromState() {
  // Sync all UI controls to S state
  const sV = (id,v) => { const el=document.getElementById(id); if(el) el.value=v; };
  const sC = (id,v) => { const el=document.getElementById(id); if(el) el.checked=v; };
  sV('lbl-w', S.width); sV('lbl-h', S.height);
  sV('font-fam', S.fontFam); sV('font-sz', S.fontSize); document.getElementById('fs-v').textContent=S.fontSize+'px';
  sV('font-wt', S.fontWt); sV('line-h', Math.round(S.lineH*10)); document.getElementById('lh-v').textContent=S.lineH;
  sV('lbl-pad', S.padding); document.getElementById('pad-v').textContent=S.padding+'px';
  sV('corner-r', S.cornerR); document.getElementById('cr-v').textContent=S.cornerR+'px';
  sV('bdr-style', S.bdrStyle); sV('bdr-w', S.bdrW); document.getElementById('bw-v').textContent=S.bdrW+'px';
  sV('logo-size', S.logoSize); document.getElementById('logo-size-v').textContent=S.logoSize+'px';
  sV('logo-op', S.logoOp); document.getElementById('logo-op-v').textContent=S.logoOp+'%';
  sV('logo-rad', S.logoRad); document.getElementById('logo-rad-v').textContent=S.logoRad+'%';
  sC('show-logo', S.showLogo); sC('leaf-bar', S.leafBar); sC('wm-tog', S.watermark);
  applyColor('bg', S.bgColor); applyColor('txt', S.txtColor); applyColor('acc', S.accColor);
  document.getElementById('c-bdr').value = S.bdrColor;
  document.getElementById('ct-bdr').value = S.bdrColor;
  // Logo pos
  document.querySelectorAll('.lpc').forEach(c=>c.classList.toggle('a',c.dataset.p===S.logoPos));
  // Align
  document.querySelectorAll('.tal-btn').forEach(b=>b.classList.toggle('active-align',b.dataset.a===S.align));
  // Size pills
  document.querySelectorAll('.spill').forEach(p=>p.classList.toggle('active',parseFloat(p.dataset.w)===S.width&&parseFloat(p.dataset.h)===S.height));
  updateSizeHdr();
}

/* â”€â”€ EVENTS â”€â”€ */
function bindEvents() {
  document.getElementById('lbl-w').addEventListener('input', e => { S.width=parseFloat(e.target.value)||4; updateSizeHdr(); debUpdate(); });
  document.getElementById('lbl-h').addEventListener('input', e => { S.height=parseFloat(e.target.value)||2.5; updateSizeHdr(); debUpdate(); });
  document.querySelectorAll('.spill').forEach(p => {
    p.addEventListener('click', () => {
      S.width=parseFloat(p.dataset.w); S.height=parseFloat(p.dataset.h);
      document.getElementById('lbl-w').value=S.width;
      document.getElementById('lbl-h').value=S.height;
      document.querySelectorAll('.spill').forEach(q=>q.classList.remove('active'));
      p.classList.add('active');
      updateSizeHdr(); updatePreview(); pushHistory();
    });
  });
  bindRange('logo-size','logo-size-v', v=>{ S.logoSize=v; return v+'px'; });
  bindRange('logo-op','logo-op-v', v=>{ S.logoOp=v; return v+'%'; });
  bindRange('logo-rad','logo-rad-v', v=>{ S.logoRad=v; return v+'%'; });
  document.getElementById('font-fam').addEventListener('change', e=>{ S.fontFam=e.target.value; updatePreview(); pushHistory(); });
  document.getElementById('font-wt').addEventListener('change', e=>{ S.fontWt=e.target.value; updatePreview(); pushHistory(); });
  bindRange('font-sz','fs-v', v=>{ S.fontSize=v; return v+'px'; });
  bindRange('line-h','lh-v', v=>{ S.lineH=(v/10).toFixed(1); return (v/10).toFixed(1); });
  bindRange('lbl-pad','pad-v', v=>{ S.padding=v; return v+'px'; });
  bindRange('corner-r','cr-v', v=>{ S.cornerR=v; return v+'px'; });
  bindRange('bdr-w','bw-v', v=>{ S.bdrW=v; return v+'px'; });
  document.getElementById('bdr-style').addEventListener('change', e=>{ S.bdrStyle=e.target.value; updatePreview(); });
  ['bg','txt','acc'].forEach(k => {
    document.getElementById('c-'+k).addEventListener('input', e=>applyColor(k,e.target.value));
    document.getElementById('ct-'+k).addEventListener('input', e=>{ if(/^#[0-9a-fA-F]{6}$/.test(e.target.value)) applyColor(k,e.target.value); });
  });
  // Keyboard
  document.addEventListener('keydown', e => {
    const tag = document.activeElement.tagName;
    if (tag==='INPUT'||tag==='TEXTAREA'||tag==='SELECT') {
      if((e.ctrlKey||e.metaKey)&&e.key==='z'){ e.preventDefault(); histUndo(); }
      if((e.ctrlKey||e.metaKey)&&e.key==='y'){ e.preventDefault(); histRedo(); }
      return;
    }
    if (e.ctrlKey||e.metaKey) {
      if(e.key==='s'){e.preventDefault();saveDesign();}
      if(e.key==='p'&&e.shiftKey){e.preventDefault();printA4Sheet();}
      else if(e.key==='p'){e.preventDefault();printSingle();}
      if(e.key==='z'){e.preventDefault();histUndo();}
      if(e.key==='y'){e.preventDefault();histRedo();}
    }
    if(e.key==='+'||e.key==='='){e.preventDefault();zoom(0.1);}
    if(e.key==='-'){e.preventDefault();zoom(-0.1);}
    if(e.key==='0'){e.preventDefault();zoomReset();}
    if(e.key.toLowerCase()==='f'){e.preventDefault();zoomFit();}
  });
  // Modal close on backdrop
  document.querySelectorAll('.modal-bg').forEach(m => m.addEventListener('click', e=>{ if(e.target===m) m.classList.remove('on'); }));
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') document.querySelectorAll('.modal-bg.on').forEach(m=>m.classList.remove('on')); });
  updateSizeHdr();
}

function bindRange(rangeId, valId, fn) {
  const r = document.getElementById(rangeId);
  const v = document.getElementById(valId);
  r.addEventListener('input', () => { const d=fn(parseFloat(r.value)); if(v) v.textContent=d; debUpdate(); });
  r.addEventListener('change', () => pushHistory());
}

function debUpdate() { clearTimeout(debTimer); debTimer=setTimeout(updatePreview, 70); }

/* â”€â”€ LOGO â”€â”€ */
function setLogoPos(pos, el) {
  S.logoPos=pos;
  document.querySelectorAll('.lpc').forEach(c=>c.classList.remove('a'));
  el.classList.add('a');
  pushHistory(); updatePreview();
}

function handleCustomLogo(e) { e.preventDefault(); handleCustomLogoFile({files:e.dataTransfer.files}); }
function handleCustomLogoFile(inp) {
  const file=inp.files?.[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{ S.customLogo=e.target.result; document.getElementById('custom-logo-label').textContent='âœ“ '+file.name; updatePreview(); showToast('Custom logo uploaded','success'); };
  reader.readAsDataURL(file);
  if(inp.value!==undefined) inp.value='';
}
function resetToDefaultLogo() {
  S.customLogo=null;
  document.getElementById('custom-logo-label').textContent='ğŸ“ Drop or click to upload';
  document.getElementById('custom-logo-inp').value='';
  updatePreview(); showToast('Reset to GT Nutri Bites logo','info');
}

/* â”€â”€ COLORS â”€â”€ */
function applyColor(k, hex) {
  const map={bg:'bgColor',txt:'txtColor',acc:'accColor'};
  S[map[k]]=hex;
  document.getElementById('c-'+k).value=hex;
  document.getElementById('ct-'+k).value=hex;
  updatePreview();
}
function syncColor(k,hex){applyColor(k,hex);}
function syncColorText(k,hex){if(/^#[0-9a-fA-F]{6}$/.test(hex))applyColor(k,hex);}
function applyPreset(name){ const p=PRESETS[name];if(!p)return;applyColor('bg',p.bg);applyColor('txt',p.txt);applyColor('acc',p.acc);pushHistory();showToast('Theme applied: '+name,'success'); }

/* â”€â”€ ALIGN â”€â”€ */
function setAlign(a,el){ S.align=a; document.querySelectorAll('.tal-btn').forEach(b=>b.classList.remove('active-align')); el.classList.add('active-align'); updatePreview(); }

/* â”€â”€ TYPE SELECT â”€â”€ */
function selectType(id) {
  S.type=id; S.fields={};
  buildTypeGrid(); buildDynFields(); prefillBrandFields(); syncFieldsToUI();
  document.getElementById('type-badge').textContent = TYPES.find(t=>t.id===id)?.name||'';
  pushHistory(); updatePreview();
}

/* â”€â”€ LOGO HTML â”€â”€ */
function logoHTML(small) {
  if(!S.showLogo) return '';
  const src=S.customLogo||LOGO_URL;
  const sz=small?Math.round(S.logoSize*0.6):S.logoSize;
  const op=S.logoOp/100;
  const rad=S.logoRad+'%';
  const posMap={tl:'flex-start',tc:'center',tr:'flex-end',ml:'flex-start','tc-inline':'center',mr:'flex-end',bl:'flex-start',bc:'center',br:'flex-end'};
  const align=posMap[S.logoPos]||'flex-start';
  return `<div style="display:flex;justify-content:${align};margin-bottom:${small?3:7}px;"><img src="${src}" crossorigin="anonymous" alt="GT Nutri Bites" style="height:${sz}px;max-width:100%;object-fit:contain;opacity:${op};border-radius:${rad};" onerror="this.style.display='none'"></div>`;
}

/* â”€â”€ CONTENT RENDERER â”€â”€ */
function f(id){ return (S.fields[id]||'').trim(); }
function fv(sf,id){ return ((sf[id]||'').trim()); }
function row(icon, text){ return text?`<div class="lbl-row"><span style="flex-shrink:0;">${icon}</span><span>${text}</span></div>`:''; }
function hd(txt,s){ return `<div style="font-family:'Playfair Display',serif;font-weight:600;font-size:${s.fontSize+3}px;color:${s.accColor};line-height:1.2;margin-bottom:4px;">${txt}</div>`; }
function div(s){ return `<div style="border-top:1.5px solid ${s.accColor};opacity:.22;margin:5px 0;"></div>`; }
function leafBar(s){ return s.leafBar?`<div style="height:3px;background:linear-gradient(90deg,${s.accColor},#c8961e,transparent);border-radius:2px;margin-bottom:${s.small?4:7}px;"></div>`:''; }
function wmark(s){ return s.watermark&&!s.small?`<div style="position:absolute;bottom:${s.padding}px;right:${s.padding}px;font-size:9px;color:${s.accColor};opacity:.35;font-weight:700;letter-spacing:.03em;">${BRAND.website}</div>`:''; }

function renderContent(type, s, fields, small) {
  const sf=fields||S.fields;
  const fval=id=>((sf[id]||'').trim());
  const lgo=logoHTML(small);
  const fs=s.fontSize||S.fontSize;
  const acc=s.accColor||S.accColor;
  const ss={...s,honey:'#c8961e',small};
  const LB=leafBar(ss);
  const WM=wmark(ss);

  switch(type) {

    case 'thankyou': return `
      ${lgo}${LB}
      <div style="text-align:center;">
        <div style="font-size:${fs+7}px;margin-bottom:3px;">ğŸ™</div>
        ${fval('customer-name')?`<div style="font-family:'Playfair Display',serif;font-size:${fs+4}px;color:${acc};">Dear ${fval('customer-name')},</div>`:`<div style="font-family:'Playfair Display',serif;font-size:${fs+4}px;color:${acc};">Thank You!</div>`}
        ${fval('order-no')?`<div style="font-size:${fs-2}px;opacity:.55;margin-top:2px;">Order: ${fval('order-no')}</div>`:''}
        ${fval('thank-msg')?`<div style="font-style:italic;font-size:${fs-1}px;margin:7px 0;opacity:.85;line-height:1.5;">${fval('thank-msg').replace(/\n/g,'<br>')}</div>`:''}
        ${div(ss)}
        ${fval('discount-code')?`<div style="background:${acc};color:#fff;padding:4px 13px;border-radius:6px;display:inline-block;font-weight:800;font-size:${fs}px;letter-spacing:.08em;margin-bottom:3px;">${fval('discount-code')}</div>`:''}
        ${fval('discount-note')?`<div style="font-size:${fs-2}px;opacity:.7;">${fval('discount-note')}</div>`:''}
        ${fval('social')?`<div style="font-size:${fs-2}px;color:${acc};margin-top:4px;font-weight:700;">ğŸŒ¿ ${fval('social')}</div>`:''}
      </div>${WM}`;

    case 'welcome': return `
      ${lgo}${LB}
      <div style="text-align:center;">
        <div style="font-size:${fs+5}px;margin-bottom:3px;">ğŸ‘‹</div>
        <div style="font-family:'Playfair Display',serif;font-size:${fs+4}px;color:${acc};">Welcome${fval('customer-name')?', '+fval('customer-name')+'!':'!'}</div>
        ${fval('welcome-msg')?`<div style="font-style:italic;font-size:${fs-1}px;margin:7px 0;opacity:.85;line-height:1.5;">${fval('welcome-msg').replace(/\n/g,'<br>')}</div>`:''}
        ${div(ss)}
        ${fval('offer')?`<div style="background:rgba(200,150,30,.12);border:1px solid rgba(200,150,30,.3);border-radius:7px;padding:5px 11px;font-size:${fs-1}px;font-weight:700;color:${acc};">ğŸ ${fval('offer')}</div>`:''}
        ${fval('social')?`<div style="font-size:${fs-2}px;color:${acc};margin-top:5px;font-weight:700;">ğŸŒ¿ ${fval('social')}</div>`:''}
        <div style="font-size:${fs-3}px;opacity:.4;margin-top:3px;">${BRAND.website}</div>
      </div>${WM}`;

    case 'delivery': return `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:5px;">
        <div>
          <div style="font-size:${fs-3}px;text-transform:uppercase;letter-spacing:.08em;font-weight:700;opacity:.45;margin-bottom:1px;">FROM</div>
          <div style="font-weight:700;font-size:${fs}px;color:${acc};">${fval('sender-name')||BRAND.name}</div>
          ${fval('sender-addr')?`<div style="font-size:${fs-2}px;opacity:.65;">${fval('sender-addr').replace(/\n/g,'<br>')}</div>`:''}
        </div>
        ${lgo}
      </div>
      ${LB}
      <div style="margin-bottom:5px;">
        <div style="font-size:${fs-3}px;text-transform:uppercase;letter-spacing:.08em;font-weight:700;opacity:.45;margin-bottom:1px;">SHIP TO</div>
        <div style="font-weight:800;font-size:${fs+4}px;color:${acc};line-height:1.1;">${fval('recv-name')}</div>
        <div style="font-size:${fs-1}px;">${fval('recv-addr').replace(/\n/g,'<br>')}</div>
      </div>
      ${div(ss)}
      <div style="display:flex;flex-wrap:wrap;gap:5px;font-size:${fs-2}px;">
        ${fval('order-no')?`<div style="background:rgba(30,77,43,.1);padding:2px 7px;border-radius:10px;font-weight:700;color:${acc};">ğŸ“‹ ${fval('order-no')}</div>`:''}
        ${fval('method')?`<div>ğŸšš ${fval('method')}</div>`:''}
        ${fval('weight')?`<div>âš– ${fval('weight')}</div>`:''}
      </div>
      ${fval('tracking')?`<div style="font-size:${fs-3}px;opacity:.45;margin-top:2px;font-family:'DM Mono',monospace;">TRK: ${fval('tracking')}</div>`:''}${WM}`;

    case 'del-ret': return `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:6px;margin-bottom:3px;">
        <div>
          <div style="font-size:${fs-3}px;text-transform:uppercase;font-weight:700;opacity:.45;letter-spacing:.06em;">FROM</div>
          <div style="font-weight:700;color:${acc};">${fval('sender-name')||BRAND.name}</div>
        </div>${lgo}
      </div>
      ${LB}
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;">
        <div style="border-right:1.5px dashed ${acc}33;padding-right:7px;">
          <div style="font-size:${fs-3}px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:${acc};margin-bottom:2px;">ğŸ“¬ Delivery</div>
          <div style="font-weight:700;font-size:${fs+1}px;">${fval('recv-name')}</div>
          <div style="font-size:${fs-2}px;opacity:.75;">${fval('recv-addr').replace(/\n/g,'<br>')}</div>
          ${fval('order-no')?`<div style="font-size:${fs-3}px;font-weight:700;color:${acc};">Order: ${fval('order-no')}</div>`:''}
          ${fval('del-date')?`<div style="font-size:${fs-3}px;opacity:.65;">ğŸ“… ${fval('del-date')}</div>`:''}
        </div>
        <div>
          <div style="font-size:${fs-3}px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:${acc};margin-bottom:2px;">â†© Return</div>
          ${fval('ret-addr')?`<div style="font-size:${fs-3}px;opacity:.75;">${fval('ret-addr').replace(/\n/g,'<br>')}</div>`:''}
          ${fval('ret-by')?`<div style="font-size:${fs-3}px;font-weight:700;color:${acc};">By: ${fval('ret-by')}</div>`:''}
          ${fval('ret-policy')?`<div style="font-size:${fs-4}px;opacity:.55;margin-top:2px;">${fval('ret-policy')}</div>`:''}
        </div>
      </div>${WM}`;

    case 'product': return `
      ${lgo}${LB}
      ${fval('prod-name')?hd(fval('prod-name'),{...ss,fontSize:fs}):''}
      ${fval('variant')?`<div style="font-size:${fs-1}px;opacity:.65;margin-bottom:2px;">${fval('variant')}</div>`:''}
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:4px;">
        ${fval('weight')?`<div style="background:${acc};color:#fff;padding:1px 8px;border-radius:10px;font-size:${fs-2}px;font-weight:700;">âš– ${fval('weight')}</div>`:''}
        ${fval('price')?`<div style="font-size:${fs+1}px;font-weight:800;color:${acc};">${fval('price')}</div>`:''}
      </div>
      ${fval('desc')?`<div style="font-size:${fs-2}px;opacity:.8;margin-bottom:4px;line-height:1.4;">${fval('desc')}</div>`:''}
      ${div(ss)}
      ${fval('ingredients')?`<div style="font-size:${fs-3}px;opacity:.75;margin-bottom:1px;"><strong>Ingredients:</strong> ${fval('ingredients')}</div>`:''}
      ${fval('allergens')?`<div style="font-size:${fs-3}px;font-weight:700;color:${acc};margin-bottom:1px;">âš  ${fval('allergens')}</div>`:''}
      ${fval('cert')?`<div style="font-size:${fs-3}px;color:${acc};font-weight:700;margin-bottom:1px;">ğŸŒ¿ ${fval('cert')}</div>`:''}
      ${fval('storage')?`<div style="font-size:${fs-3}px;opacity:.6;">ğŸ“¦ ${fval('storage')}</div>`:''}
      <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:2px;">
        ${fval('best-before')?`<div style="font-size:${fs-3}px;opacity:.55;">ğŸ“… Best Before: ${fval('best-before')}</div>`:''}
        ${fval('batch-no')?`<div style="font-size:${fs-3}px;opacity:.4;">Batch: ${fval('batch-no')}</div>`:''}
        ${fval('sku')?`<div style="font-size:${fs-3}px;opacity:.4;">SKU: ${fval('sku')}</div>`:''}
      </div>${WM}`;

    case 'contact': return `
      ${lgo}${LB}
      ${fval('comp-name')?hd(fval('comp-name'),{...ss,fontSize:fs}):hd(BRAND.name,{...ss,fontSize:fs})}
      ${div(ss)}
      ${row('ğŸ“',fval('phone'))}
      ${row('âœ‰',fval('email'))}
      ${row('ğŸŒ',fval('website'))}
      ${fval('address')?`<div class="lbl-row"><span>ğŸ“</span><span style="font-size:${fs-1}px;">${fval('address').replace(/\n/g,'<br>')}</span></div>`:''}
      ${row('ğŸ•',fval('hours'))}
      ${row('ğŸŒ¿',fval('social'))}
      ${fval('cta')?`<div style="margin-top:5px;font-size:${fs-2}px;font-weight:700;color:${acc};">${fval('cta')}</div>`:''}${WM}`;

    case 'promo': return `
      ${lgo}${LB}
      <div style="text-align:center;">
        <div style="font-family:'Playfair Display',serif;font-size:${fs+5}px;font-weight:700;color:${acc};line-height:1.2;margin-bottom:6px;">${fval('headline')||'Special Offer!'}</div>
        ${fval('discount')?`<div style="background:linear-gradient(135deg,${acc},#c8961e);color:#fff;padding:8px 20px;border-radius:30px;display:inline-block;font-size:${fs+6}px;font-weight:800;margin-bottom:8px;letter-spacing:-.01em;">${fval('discount')}</div>`:''}
        ${fval('code')?`<div style="border:2px dashed ${acc};border-radius:8px;padding:4px 14px;display:inline-block;font-size:${fs+2}px;font-weight:800;letter-spacing:.1em;color:${acc};margin-bottom:5px;">CODE: ${fval('code')}</div>`:''}
        ${fval('details')?`<div style="font-size:${fs-2}px;opacity:.75;margin:5px 0;line-height:1.5;">${fval('details').replace(/\n/g,'<br>')}</div>`:''}
        ${fval('expiry')?`<div style="font-size:${fs-3}px;opacity:.55;margin-top:4px;">â° ${fval('expiry')}</div>`:''}
        ${fval('social')?`<div style="font-size:${fs-2}px;color:${acc};margin-top:4px;font-weight:700;">ğŸŒ¿ ${fval('social')}</div>`:''}
      </div>${WM}`;

    case 'ingredient': return `
      ${lgo}${LB}
      ${fval('prod-name')?`<div style="font-family:'Playfair Display',serif;font-size:${fs+1}px;font-weight:600;color:${acc};margin-bottom:3px;">${fval('prod-name')}</div>`:''}
      <div style="background:rgba(30,77,43,.06);border-radius:6px;padding:5px 7px;margin-bottom:4px;">
        <div style="font-size:${fs-3}px;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:${acc};margin-bottom:3px;">Nutrition Facts</div>
        ${fval('serving')?`<div style="font-size:${fs-3}px;opacity:.7;margin-bottom:3px;">Serving Size: ${fval('serving')}</div>`:''}
        ${fval('calories')?`<div style="font-size:${fs+2}px;font-weight:800;color:${acc};">${fval('calories')}</div>`:''}
        ${div(ss)}
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px;font-size:${fs-3}px;">
          ${fval('protein')?`<div><span style="opacity:.6;">Protein</span> <strong>${fval('protein')}</strong></div>`:''}
          ${fval('fat')?`<div><span style="opacity:.6;">Total Fat</span> <strong>${fval('fat')}</strong></div>`:''}
          ${fval('carbs')?`<div><span style="opacity:.6;">Carbs</span> <strong>${fval('carbs')}</strong></div>`:''}
          ${fval('fiber')?`<div><span style="opacity:.6;">Fiber</span> <strong>${fval('fiber')}</strong></div>`:''}
          ${fval('sugar')?`<div><span style="opacity:.6;">Sugars</span> <strong>${fval('sugar')}</strong></div>`:''}
          ${fval('sodium')?`<div><span style="opacity:.6;">Sodium</span> <strong>${fval('sodium')}</strong></div>`:''}
        </div>
      </div>
      ${fval('vitamins')?`<div style="font-size:${fs-3}px;opacity:.65;margin-bottom:2px;">ğŸŒŸ ${fval('vitamins')}</div>`:''}
      ${fval('cert')?`<div style="font-size:${fs-3}px;color:${acc};font-weight:700;">ğŸŒ¿ ${fval('cert')}</div>`:''}${WM}`;

    default: return `<div style="text-align:center;opacity:.3;padding:20px;">Select a label type</div>`;
  }
}

/* â”€â”€ UPDATE PREVIEW â”€â”€ */
function updatePreview() {
  const canvas = document.getElementById('label-canvas');
  const inner  = document.getElementById('label-inner');
  const wpx = Math.round(S.width * DPI);
  const hpx = Math.round(S.height * DPI);
  canvas.style.width  = wpx+'px';
  canvas.style.height = hpx+'px';
  canvas.style.borderRadius = S.cornerR+'px';
  if (S.bdrStyle && S.bdrStyle!=='none') {
    canvas.style.border = `${S.bdrW}px ${S.bdrStyle} ${S.bdrColor}`;
  } else {
    canvas.style.border = '2px dashed #c0b8a0';
  }
  inner.style.cssText = `width:100%;height:100%;position:relative;overflow:hidden;background:${S.bgColor};color:${S.txtColor};font-family:${S.fontFam};font-size:${S.fontSize}px;font-weight:${S.fontWt};text-align:${S.align};line-height:${S.lineH};padding:${S.padding}px;box-sizing:border-box;`;
  inner.innerHTML = renderContent(S.type, S, S.fields, false);
  updateSheetInfo();
}

/* â”€â”€ SHEET INFO (SIDEBAR) â”€â”€ */
function updateSheetInfo() {
  const landscape = document.getElementById('sheet-landscape')?.checked;
  const A4w = landscape ? 297 : 210;
  const A4h = landscape ? 210 : 297;
  const margin = parseFloat(document.getElementById('sheet-margin')?.value||8);
  const gap    = parseFloat(document.getElementById('sheet-gap')?.value||4);
  const cols   = parseInt(document.getElementById('sheet-cols')?.value||2);
  const rows   = parseInt(document.getElementById('sheet-rows')?.value||4);
  const lblWmm = (A4w - margin*2 - gap*(cols-1)) / cols;
  const lblHmm = (A4h - margin*2 - gap*(rows-1)) / rows;
  const lblWin = (lblWmm / 25.4).toFixed(2);
  const lblHin = (lblHmm / 25.4).toFixed(2);
  const total  = cols * rows;
  const el = document.getElementById('sheet-info-text');
  if (el) el.innerHTML = `ğŸ“„ ${cols}Ã—${rows} = <strong>${total} labels</strong> per sheet &nbsp;|&nbsp; Each label: <strong>${lblWmm.toFixed(1)}Ã—${lblHmm.toFixed(1)}mm</strong> (${lblWin}"Ã—${lblHin}") &nbsp;|&nbsp; ${landscape?'Landscape':'Portrait'} A4`;
}

/* â”€â”€ SHEET PREVIEW LOGIC â”€â”€ */
let sheetSource = 'single';
function setSheetSource(src) {
  sheetSource = src;
  document.getElementById('sheet-copy-box').style.display = src==='single' ? 'block' : 'none';
  updateSheetPreview();
}

function updateSheetPreview() { updateSheetInfo(); }

/* â”€â”€ BUILD SHEET DOM â”€â”€ */
function buildSheetDOM(scale) {
  const landscape = document.getElementById('sheet-landscape').checked;
  const A4w_mm    = landscape ? 297 : 210;
  const A4h_mm    = landscape ? 210 : 297;
  const margin_mm = parseFloat(document.getElementById('sheet-margin').value)||8;
  const gap_mm    = parseFloat(document.getElementById('sheet-gap').value)||4;
  const cols      = Math.max(1, parseInt(document.getElementById('sheet-cols').value)||2);
  const rows      = Math.max(1, parseInt(document.getElementById('sheet-rows').value)||4);
  const showCuts  = document.getElementById('sheet-cut-marks').checked;
  const totalCells= cols * rows;

  // Label content list
  let labelItems = [];
  if (sheetSource === 'batch' && batchData.length > 0) {
    for (let i = 0; i < totalCells; i++) {
      if (i < batchData.length) labelItems.push({ type: batchData[i].type, fields: batchData[i].fields });
      else labelItems.push(null);
    }
  } else {
    const copies = Math.min(parseInt(document.getElementById('sheet-copies').value)||8, totalCells);
    for (let i = 0; i < totalCells; i++) {
      if (i < copies) labelItems.push({ type: S.type, fields: S.fields });
      else labelItems.push(null);
    }
  }

  const sc = scale || 1;
  const A4w_px = A4w_mm * PX_PER_MM * sc;
  const A4h_px = A4h_mm * PX_PER_MM * sc;
  const margin_px = margin_mm * PX_PER_MM * sc;
  const gap_px    = gap_mm * PX_PER_MM * sc;
  const lblW_px   = (A4w_px - margin_px*2 - gap_px*(cols-1)) / cols;
  const lblH_px   = (A4h_px - margin_px*2 - gap_px*(rows-1)) / rows;
  const cutLen    = 5 * sc;
  const cutOff    = 2 * sc;

  const sheet = document.createElement('div');
  sheet.style.cssText = `width:${A4w_px}px;height:${A4h_px}px;background:#fff;position:relative;overflow:hidden;box-sizing:border-box;`;

  labelItems.forEach((item, idx) => {
    const col = idx % cols;
    const row = Math.floor(idx / cols);
    const x = margin_px + col * (lblW_px + gap_px);
    const y = margin_px + row * (lblH_px + gap_px);

    if (showCuts) {
      // top-left corner
      addCutMark(sheet, x - cutOff, y - cutLen, 'v', cutLen, sc);
      addCutMark(sheet, x - cutLen, y - cutOff, 'h', cutLen, sc);
      // top-right corner
      addCutMark(sheet, x + lblW_px + cutOff, y - cutLen, 'v', cutLen, sc);
      addCutMark(sheet, x + lblW_px, y - cutOff, 'h', cutLen, sc);
      // bottom-left corner
      addCutMark(sheet, x - cutOff, y + lblH_px, 'v', cutLen, sc);
      addCutMark(sheet, x - cutLen, y + lblH_px + cutOff, 'h', cutLen, sc);
      // bottom-right corner
      addCutMark(sheet, x + lblW_px + cutOff, y + lblH_px, 'v', cutLen, sc);
      addCutMark(sheet, x + lblW_px, y + lblH_px + cutOff, 'h', cutLen, sc);
    }

    const cell = document.createElement('div');
    cell.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:${lblW_px}px;height:${lblH_px}px;overflow:hidden;box-sizing:border-box;`;

    if (item) {
      const lss = {
        ...S,
        fontSize: Math.max(7, Math.round(S.fontSize * (lblW_px / (S.width * DPI * sc)) * sc)),
        padding: Math.max(4, Math.round(S.padding * (lblW_px / (S.width * DPI * sc)) * sc)),
        leafBar: S.leafBar,
        watermark: false,
        small: true,
      };
      const inner = document.createElement('div');
      inner.style.cssText = `width:100%;height:100%;background:${S.bgColor};color:${S.txtColor};font-family:${S.fontFam};font-size:${lss.fontSize}px;font-weight:${S.fontWt};line-height:${S.lineH};padding:${lss.padding}px;box-sizing:border-box;overflow:hidden;position:relative;`;
      if (S.bdrStyle && S.bdrStyle!=='none') {
        inner.style.border = `${Math.max(1,S.bdrW*sc)}px ${S.bdrStyle} ${S.bdrColor}`;
      }
      if (S.cornerR) inner.style.borderRadius = S.cornerR*sc+'px';
      inner.innerHTML = renderContent(item.type, lss, item.fields, true);
      cell.appendChild(inner);
    } else {
      // Empty cell - dotted placeholder
      cell.style.border = '1px dashed #ddd';
    }

    sheet.appendChild(cell);
  });

  return { sheet, cols, rows, totalCells, A4w_px, A4h_px, labelItems };
}

function addCutMark(parent, x, y, dir, len, sc) {
  const el = document.createElement('div');
  if (dir === 'h') {
    el.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:${len}px;height:${0.5*sc}px;background:#aaa;`;
  } else {
    el.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:${0.5*sc}px;height:${len}px;background:#aaa;`;
  }
  parent.appendChild(el);
}

/* â”€â”€ SHEET PREVIEW MODAL â”€â”€ */
function previewSheetModal() {
  const { sheet, cols, rows, totalCells } = buildSheetDOM(0.7);
  const container = document.getElementById('sp-modal-sheet');
  container.innerHTML = '';
  sheet.style.boxShadow = '0 4px 20px rgba(0,0,0,.25)';
  container.appendChild(sheet);
  const src = sheetSource === 'batch' && batchData.length ? `${batchData.length} batch labels` : 'current label repeated';
  document.getElementById('sp-modal-info').textContent = `${cols}Ã—${rows} grid â€” ${totalCells} cells â€” ${src}`;
  openModal('sheet-preview-modal');
}

/* â”€â”€ PRINT A4 SHEET â”€â”€ */
async function printA4Sheet() {
  showLoad('Preparing A4 sheet for printâ€¦','Arranging labelsâ€¦');
  const { sheet } = buildSheetDOM(1);
  sheet.style.position = 'fixed';
  sheet.style.top = '0'; sheet.style.left = '0';
  const pr = document.getElementById('print-root');
  pr.innerHTML = ''; pr.appendChild(sheet);
  await new Promise(r=>setTimeout(r,300));
  hideLoad();
  // Override print CSS for this
  const style = document.createElement('style');
  style.id = 'sheet-print-style';
  style.textContent = `@media print { @page { size: ${document.getElementById('sheet-landscape').checked?'landscape':'portrait'}; margin:0; } #print-root > div { position:fixed!important;top:0!important;left:0!important; } }`;
  document.head.appendChild(style);
  window.print();
  setTimeout(()=>{ pr.innerHTML=''; document.getElementById('sheet-print-style')?.remove(); },1500);
}

/* â”€â”€ EXPORT SHEET PDF â”€â”€ */
async function exportSheetPDF() {
  showLoad('Generating A4 Sheet PDFâ€¦','Rendering labels at high qualityâ€¦');
  const landscape = document.getElementById('sheet-landscape').checked;
  const {jsPDF} = window.jspdf;
  const pdf = new jsPDF({ unit:'mm', format:'a4', orientation: landscape?'landscape':'portrait' });
  const A4w = landscape?297:210, A4h = landscape?210:297;

  // Build at 2x scale for quality
  const { sheet } = buildSheetDOM(2);
  sheet.style.cssText += ';position:fixed;left:-9999px;top:-9999px;';
  document.body.appendChild(sheet);
  await new Promise(r=>setTimeout(r,300));
  try {
    const canvas = await html2canvas(sheet, { scale:1, useCORS:true, allowTaint:true, backgroundColor:'#ffffff', logging:false });
    pdf.addImage(canvas.toDataURL('image/png','1.0'), 'PNG', 0, 0, A4w, A4h);
    pdf.save('gt-nutri-bites-sheet.pdf');
    showToast('A4 Sheet PDF exported!','success');
  } catch(e) {
    showToast('PDF export failed','error');
  }
  document.body.removeChild(sheet);
  hideLoad();
}

/* â”€â”€ SIZE HEADER â”€â”€ */
function updateSizeHdr() {
  document.getElementById('size-hdr').textContent = S.width+'" Ã— '+S.height+'"';
}

/* â”€â”€ ZOOM â”€â”€ */
let zVal = 1;
function zoom(d){ zVal=Math.min(4,Math.max(0.15,zVal+d)); applyZoom(); }
function zoomReset(){ zVal=1; applyZoom(); }
function zoomFit(){
  const area=document.getElementById('preview-area');
  const wpx=Math.round(S.width*DPI),hpx=Math.round(S.height*DPI);
  zVal=Math.min((area.clientWidth-80)/wpx,(area.clientHeight-80)/hpx,3);
  applyZoom();
}
function applyZoom(){
  const c=document.getElementById('label-canvas');
  c.style.transform=`scale(${zVal})`;
  c.style.transformOrigin='center center';
  document.getElementById('zoom-lbl').textContent=Math.round(zVal*100)+'%';
}

/* â”€â”€ TAB SWITCH â”€â”€ */
function switchTab(tab, el) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  if (el) el.classList.add('active');
  else document.querySelector(`[data-tab="${tab}"]`)?.classList.add('active');
  document.getElementById('panel-'+tab)?.classList.add('active');
  if (tab === 'sheet') {
    // Refresh batch count badge
    const bc = document.getElementById('batch-src-count');
    if (bc) bc.textContent = batchData.length ? batchData.length+' labels' : '';
  }
}

/* â”€â”€ SECTION TOGGLE â”€â”€ */
function toggleSec(btn) {
  btn.classList.toggle('open');
  const body=btn.nextElementSibling;
  if(body?.classList.contains('sec-body')) body.classList.toggle('open');
}

/* â”€â”€ SIDEBAR â”€â”€ */
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebar-overlay').classList.toggle('on');
}

/* â”€â”€ DARK MODE â”€â”€ */
function toggleDark(cb){ document.body.classList.toggle('dark-mode',cb.checked); }

/* â”€â”€ LOADING â”€â”€ */
let progTimer;
function showLoad(txt,sub){
  document.getElementById('loading').classList.add('on');
  document.getElementById('load-txt').textContent=txt||'Processingâ€¦';
  document.getElementById('load-sub').textContent=sub||'';
  let p=0; const bar=document.getElementById('load-bar');
  bar.style.width='0%';
  clearInterval(progTimer);
  progTimer=setInterval(()=>{ p=Math.min(p+5,88); bar.style.width=p+'%'; },200);
}
function hideLoad(){
  clearInterval(progTimer);
  document.getElementById('load-bar').style.width='100%';
  setTimeout(()=>{ document.getElementById('loading').classList.remove('on'); document.getElementById('load-bar').style.width='0%'; },400);
}

/* â”€â”€ PRINT SINGLE / MULTI COPIES â”€â”€ */
function printSingle() {
  const copies = parseInt(document.getElementById('single-copies')?.value||1);
  const pr = document.getElementById('print-root');
  pr.innerHTML = '';
  const c = document.getElementById('label-canvas');
  for (let i = 0; i < copies; i++) {
    const cl = c.cloneNode(true);
    cl.style.border='none';cl.style.boxShadow='none';cl.style.transform='none';
    cl.style.position='fixed';cl.style.top='0';cl.style.left='0';
    cl.style.margin='0';cl.style.pageBreakAfter='always';
    pr.appendChild(cl);
  }
  setTimeout(()=>{ window.print(); setTimeout(()=>{ pr.innerHTML=''; },1500); },200);
}

function getScale(){ return parseInt(document.getElementById('exp-quality')?.value||2); }

function dlPDF(){
  showLoad('Generating PDFâ€¦','Rendering at high quality');
  const c=document.getElementById('label-canvas');
  html2canvas(c,{scale:getScale(),useCORS:true,allowTaint:true,backgroundColor:S.bgColor,logging:false}).then(canvas=>{
    const{jsPDF}=window.jspdf;
    const pdf=new jsPDF({unit:'in',format:[S.width,S.height],orientation:S.width>=S.height?'landscape':'portrait'});
    pdf.addImage(canvas.toDataURL('image/png'),'PNG',0,0,S.width,S.height);
    pdf.save('gt-nutri-bites-label.pdf');
    hideLoad();showToast('PDF downloaded!','success');
  }).catch(()=>{hideLoad();showToast('PDF export failed','error');});
}

function dlPNG(){
  showLoad('Generating PNGâ€¦');
  const c=document.getElementById('label-canvas');
  html2canvas(c,{scale:getScale(),useCORS:true,allowTaint:true,backgroundColor:S.bgColor,logging:false}).then(canvas=>{
    const a=document.createElement('a');
    a.download='gt-nutri-bites-label.png';
    a.href=canvas.toDataURL('image/png');a.click();
    hideLoad();showToast('PNG downloaded!','success');
  }).catch(()=>{hideLoad();showToast('PNG export failed','error');});
}

/* â”€â”€ COPY HTML â”€â”€ */
function copyLabelHTML(){
  const c=document.getElementById('label-inner').cloneNode(true);
  navigator.clipboard?.writeText(c.outerHTML).then(()=>showToast('Label HTML copied!','success')).catch(()=>showToast('Copy failed','error'));
}

/* â”€â”€ SAVE / LOAD â”€â”€ */
function saveDesign(){
  try{
    const snap={...S,customLogo:'__has__',zoom:zVal};
    localStorage.setItem('gtnb_design',JSON.stringify(snap));
    localStorage.setItem('gtnb_logo',S.customLogo||'');
    const lbl=document.getElementById('autosave-lbl');
    if(lbl)lbl.textContent='Saved '+new Date().toLocaleTimeString();
    showToast('Design saved!','success');
  }catch(e){showToast('Save failed â€” storage full?','error');}
}

function autoSaveDesign(){
  try{
    localStorage.setItem('gtnb_autosave',JSON.stringify({...S,zoom:zVal}));
    const lbl=document.getElementById('autosave-lbl');
    if(lbl)lbl.textContent='Auto-saved '+new Date().toLocaleTimeString();
  }catch(e){}
}

function autoLoadDesign(){
  // Try to load full save first, else autosave
  const d=localStorage.getItem('gtnb_design')||localStorage.getItem('gtnb_autosave');
  if(!d) return;
  try{
    const snap=JSON.parse(d);
    const logo=localStorage.getItem('gtnb_logo')||null;
    if(logo)snap.customLogo=logo; else snap.customLogo=null;
    Object.assign(S,snap);
    zVal=S.zoom||1;
    buildTypeGrid();buildDynFields();syncFieldsToUI();syncUIFromState();applyZoom();updateSizeHdr();updatePreview();
    document.getElementById('type-badge').textContent=TYPES.find(t=>t.id===S.type)?.name||'';
    pushHistory();
  }catch(e){}
}

function loadDesign(){
  try{
    const d=localStorage.getItem('gtnb_design');
    if(!d){showToast('No saved design found','warn');return;}
    const snap=JSON.parse(d);
    const logo=localStorage.getItem('gtnb_logo')||null;
    snap.customLogo=logo;
    Object.assign(S,snap);
    zVal=S.zoom||1;
    buildTypeGrid();buildDynFields();syncFieldsToUI();syncUIFromState();applyZoom();updateSizeHdr();updatePreview();
    pushHistory();showToast('Design loaded!','success');
  }catch(e){showToast('Load failed','error');}
}

function clearAll(){
  if(!confirm('Reset all settings to default?'))return;
  S={type:'thankyou',logoPos:'tc-inline',logoSize:72,logoOp:100,logoRad:0,showLogo:true,customLogo:null,bgColor:'#ffffff',txtColor:'#1a1a0e',accColor:'#1e4d2b',bdrColor:'#1e4d2b',fontFam:"'Nunito',sans-serif",fontSize:13,fontWt:'400',align:'left',lineH:1.4,padding:14,cornerR:0,bdrStyle:'none',bdrW:1,leafBar:true,watermark:true,fields:{},width:4,height:2.5,zoom:1};
  zVal=1;buildTypeGrid();buildDynFields();prefillBrandFields();syncFieldsToUI();syncUIFromState();applyZoom();updateSizeHdr();updatePreview();
  history=[];histIdx=-1;updateHistBtns();
  showToast('Reset to defaults','info');
}

/* â”€â”€ BATCH LOGIC â”€â”€ */
function handleBatchDrop(e){
  e.preventDefault();document.getElementById('batch-dz').classList.remove('over');handleBatchFile({files:e.dataTransfer.files});
}
function handleBatchFile(inp){
  const file=inp.files?.[0];if(!file)return;
  if(!file.name.endsWith('.csv')){showToast('Please upload a .csv file','error');return;}
  const btype=document.getElementById('batch-type').value;
  if(!btype){showToast('Select a label type first','warn');return;}
  const reader=new FileReader();
  reader.onload=e=>{
    const rows=parseCSV(e.target.result);
    if(rows.length<2){showToast('CSV must have header + at least one row','error');return;}
    const hdrs=rows[0].map(h=>h.trim().toLowerCase().replace(/ /g,'-'));
    const defs=FIELDS[btype]||[];
    const dataRows=rows.slice(1).filter(r=>r.some(c=>c.trim()));
    batchData=dataRows.map((row,i)=>{
      const fields={};
      defs.forEach((fd,j)=>{
        const ci=hdrs.indexOf(fd.id.toLowerCase());
        fields[fd.id]=ci>=0?(row[ci]||'').trim():(row[j]||'').trim();
      });
      return{id:i+1,type:btype,fields,status:'pending'};
    });
    renderBatchList();
    // Update sheet tab badge
    const bc=document.getElementById('batch-src-count');if(bc)bc.textContent=batchData.length+' labels';
    showToast(`${batchData.length} label${batchData.length!==1?'s':''} loaded`,'success');
  };
  reader.readAsText(file,'UTF-8');
  if(inp.value!==undefined)inp.value='';
}

function parseCSV(txt){
  const lines=txt.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim());
  return lines.map(line=>{
    const cells=[];let cur='',inQ=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){inQ=!inQ;}
      else if(c===','&&!inQ){cells.push(cur);cur='';}
      else cur+=c;
    }
    cells.push(cur);
    return cells.map(c=>c.trim().replace(/^"|"$/g,''));
  });
}

function renderBatchList(){
  const st=document.getElementById('batch-status');
  st.style.display='block';
  document.getElementById('batch-count-lbl').textContent=batchData.length+' label'+(batchData.length!==1?'s':'');
  const list=document.getElementById('batch-list');
  list.innerHTML='';
  batchData.forEach(item=>{
    const t=TYPES.find(x=>x.id===item.type);
    const firstField=Object.values(item.fields)[0]||'Label '+item.id;
    const card=document.createElement('div');
    card.className='batch-row';
    card.id='br-'+item.id;
    card.innerHTML=`<div class="bnum">${item.id}</div><div style="flex:1;min-width:0;"><div style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${firstField||'Label '+item.id}</div><div style="font-size:10px;color:var(--mist);">${t?.ico||''} ${t?.name||item.type}</div></div><div class="bstat pend" id="bs-${item.id}">â³</div>`;
    list.appendChild(card);
  });
}

function clearBatch(){
  batchData=[];
  document.getElementById('batch-status').style.display='none';
  document.getElementById('batch-fill').style.width='0%';
  const bc=document.getElementById('batch-src-count');if(bc)bc.textContent='';
  showToast('Batch cleared','info');
}

function setBatchStatus(id,st){
  const el=document.getElementById('bs-'+id);if(!el)return;
  const m={rendering:'ğŸ”„',done:'âœ“',error:'âœ•',pending:'â³'};
  el.textContent=m[st]||st;
  el.className='bstat '+(st==='done'?'done':st==='error'?'err':'pend');
}
function setBatchProg(pct){document.getElementById('batch-fill').style.width=pct+'%';}

async function openBatchPreview(){
  if(!batchData.length){showToast('Upload a CSV first','warn');return;}
  const grid=document.getElementById('batch-prev-grid');
  grid.innerHTML='<div style="padding:20px;color:var(--mist);width:100%;text-align:center;">Rendering previewsâ€¦</div>';
  document.getElementById('batch-modal-count').textContent=batchData.length+' label'+(batchData.length!==1?'s':'');
  openModal('batch-modal');
  const SDPI=52;
  const wpx=Math.round(S.width*SDPI),hpx=Math.round(S.height*SDPI);
  grid.innerHTML='';
  batchData.forEach(item=>{
    const ss={...S,fontSize:Math.round(S.fontSize*.55),padding:Math.round(S.padding*.55),leafBar:false,watermark:false};
    const wrap=document.createElement('div');
    wrap.style.position='relative';wrap.style.cursor='pointer';wrap.title='Label '+item.id;
    const lbl=document.createElement('div');
    lbl.style.cssText=`width:${wpx}px;height:${hpx}px;background:${S.bgColor};border:1px solid #c0b8a0;border-radius:4px;overflow:hidden;position:relative;font-family:${S.fontFam};font-size:${ss.fontSize}px;color:${S.txtColor};padding:${ss.padding}px;box-sizing:border-box;transition:box-shadow .15s;`;
    lbl.innerHTML=renderContent(item.type,ss,item.fields,true);
    lbl.onmouseenter=()=>{lbl.style.boxShadow='0 4px 12px rgba(0,0,0,.2)';};
    lbl.onmouseleave=()=>{lbl.style.boxShadow='';};
    const num=document.createElement('div');
    num.style.cssText='position:absolute;top:-6px;left:-6px;width:18px;height:18px;border-radius:50%;background:var(--forest);color:#fff;font-size:9px;font-weight:800;display:flex;align-items:center;justify-content:center;font-family:"DM Mono",monospace;';
    num.textContent=item.id;
    wrap.appendChild(lbl);wrap.appendChild(num);grid.appendChild(wrap);
  });
}

async function batchPrint(){
  if(!batchData.length){showToast('Upload a CSV first','warn');return;}
  showLoad(`Preparing ${batchData.length} labelsâ€¦`);
  const pr=document.getElementById('print-root');
  pr.innerHTML='';
  const wpx=Math.round(S.width*DPI),hpx=Math.round(S.height*DPI);
  batchData.forEach(item=>{
    const wrap=document.createElement('div');
    wrap.style.cssText=`width:${wpx}px;height:${hpx}px;page-break-after:always;overflow:hidden;box-sizing:border-box;`;
    const inner=document.createElement('div');
    inner.style.cssText=`width:100%;height:100%;background:${S.bgColor};color:${S.txtColor};font-family:${S.fontFam};font-size:${S.fontSize}px;font-weight:${S.fontWt};line-height:${S.lineH};padding:${S.padding}px;box-sizing:border-box;overflow:hidden;`;
    inner.innerHTML=renderContent(item.type,S,item.fields,false);
    wrap.appendChild(inner);pr.appendChild(wrap);
  });
  setTimeout(()=>{hideLoad();window.print();setTimeout(()=>{pr.innerHTML='';},2000);},600);
}

async function batchPDF(){
  if(!batchData.length){showToast('Upload a CSV first','warn');return;}
  showLoad(`Generating PDF for ${batchData.length} labelsâ€¦`,'This may take a momentâ€¦');
  const{jsPDF}=window.jspdf;
  const pdf=new jsPDF({unit:'in',format:[S.width,S.height],orientation:S.width>=S.height?'landscape':'portrait'});
  const wpx=Math.round(S.width*DPI),hpx=Math.round(S.height*DPI);
  for(let i=0;i<batchData.length;i++){
    const item=batchData[i];
    setBatchProg((i/batchData.length)*90);
    setBatchStatus(item.id,'rendering');
    const el=document.createElement('div');
    el.style.cssText=`position:fixed;left:-9999px;top:-9999px;width:${wpx}px;height:${hpx}px;background:${S.bgColor};color:${S.txtColor};font-family:${S.fontFam};font-size:${S.fontSize}px;font-weight:${S.fontWt};line-height:${S.lineH};padding:${S.padding}px;box-sizing:border-box;overflow:hidden;`;
    el.innerHTML=renderContent(item.type,S,item.fields,false);
    document.body.appendChild(el);
    await new Promise(r=>setTimeout(r,60));
    try{
      const canvas=await html2canvas(el,{scale:2,useCORS:true,allowTaint:true,backgroundColor:S.bgColor,logging:false});
      if(i>0)pdf.addPage([S.width,S.height]);
      pdf.addImage(canvas.toDataURL('image/png'),'PNG',0,0,S.width,S.height);
      setBatchStatus(item.id,'done');
    }catch{setBatchStatus(item.id,'error');}
    document.body.removeChild(el);
  }
  setBatchProg(100);
  pdf.save('gt-nutri-bites-batch-labels.pdf');
  hideLoad();showToast(`${batchData.length} labels exported as PDF!`,'success');
}

async function batchPNGs(){
  if(!batchData.length){showToast('Upload a CSV first','warn');return;}
  showLoad(`Generating ${batchData.length} PNG filesâ€¦`);
  const wpx=Math.round(S.width*DPI),hpx=Math.round(S.height*DPI);
  for(let i=0;i<batchData.length;i++){
    const item=batchData[i];
    setBatchProg((i/batchData.length)*100);
    const el=document.createElement('div');
    el.style.cssText=`position:fixed;left:-9999px;top:-9999px;width:${wpx}px;height:${hpx}px;background:${S.bgColor};color:${S.txtColor};font-family:${S.fontFam};font-size:${S.fontSize}px;font-weight:${S.fontWt};line-height:${S.lineH};padding:${S.padding}px;box-sizing:border-box;overflow:hidden;`;
    el.innerHTML=renderContent(item.type,S,item.fields,false);
    document.body.appendChild(el);
    await new Promise(r=>setTimeout(r,80));
    try{
      const canvas=await html2canvas(el,{scale:2,useCORS:true,backgroundColor:S.bgColor,logging:false});
      const a=document.createElement('a');
      a.href=canvas.toDataURL('image/png');
      a.download=`gtnb-${String(i+1).padStart(3,'0')}-${item.type}.png`;
      a.click();
      setBatchStatus(item.id,'done');
    }catch{setBatchStatus(item.id,'error');}
    document.body.removeChild(el);
    await new Promise(r=>setTimeout(r,120));
  }
  setBatchProg(100);
  hideLoad();showToast(`${batchData.length} PNGs downloaded!`,'success');
}

/* â”€â”€ CSV TEMPLATE â”€â”€ */
function selectCSVType(id,el){
  csvTypeSel=id;
  document.querySelectorAll('#csv-type-grid > div').forEach(c=>{
    c.style.borderColor='var(--parchment)';c.style.background='var(--cream)';c.style.color='var(--mist)';
  });
  el.style.borderColor='var(--forest)';el.style.background='var(--forest)';el.style.color='#fff';
  const defs=FIELDS[id]||[];
  const t=TYPES.find(x=>x.id===id);
  const hdrs=defs.map(f=>f.id);
  const samples=CSV_SAMPLES[id]||[[]];
  let txt='# GT Nutri Bites â€” '+t.name+' CSV Template\n';
  txt+='# Fill one row per label. Do not edit the header row.\n';
  defs.forEach(f=>{txt+=`# "${f.id}" â€” ${f.label}${f.req?' (REQUIRED)':''}\n`;});
  txt+='#\n';
  if(hdrs.length){txt+=hdrs.map(h=>`"${h}"`).join(',')+'\n';}
  samples.forEach(row=>{txt+=row.map(c=>`"${(c||'').replace(/"/g,'""')}"`).join(',')+'\n';});
  for(let i=samples.length;i<8;i++){if(hdrs.length)txt+=hdrs.map(()=>'""').join(',')+'\n';}
  document.getElementById('csv-type-title').textContent=t.ico+' '+t.name;
  document.getElementById('csv-col-badge').textContent=defs.length+' columns';
  document.getElementById('csv-pre-content').textContent=txt;
  document.getElementById('csv-preview-wrap').style.display='block';
  document.getElementById('btn-dl-csv').disabled=false;
}

function downloadCSV(){
  if(!csvTypeSel)return;
  const defs=FIELDS[csvTypeSel]||[];
  const hdrs=defs.map(f=>f.id);
  const samples=CSV_SAMPLES[csvTypeSel]||[[]];
  let txt='';
  if(hdrs.length){txt+=hdrs.map(h=>`"${h}"`).join(',')+'\n';}
  samples.forEach(row=>{txt+=row.map(c=>`"${(c||'').replace(/"/g,'""')}"`).join(',')+'\n';});
  for(let i=samples.length;i<10;i++){if(hdrs.length)txt+=hdrs.map(()=>'""').join(',')+'\n';}
  const blob=new Blob([txt],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`gt-nutri-bites-${csvTypeSel}-template.csv`;
  a.click();
  showToast('CSV template downloaded!','success');
}

/* â”€â”€ MODAL â”€â”€ */
function openModal(id){document.getElementById(id).classList.add('on');}
function closeModal(id){document.getElementById(id).classList.remove('on');}

/* â”€â”€ TOAST â”€â”€ */
function showToast(msg,type='info'){
  const area=document.getElementById('toast-area');
  const el=document.createElement('div');
  const icons={success:'âœ“',error:'âœ•',warn:'âš ',info:'ğŸŒ¿'};
  el.className=`toast t-${type}`;
  el.innerHTML=`<span>${icons[type]||'â€¢'}</span><span>${msg}</span>`;
  area.appendChild(el);
  setTimeout(()=>{el.classList.add('out');setTimeout(()=>el.remove(),300);},3200);
}

/* â”€â”€ BOOT â”€â”€ */
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
